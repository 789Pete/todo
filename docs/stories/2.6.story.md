# Story 2.6: Navigation Breadcrumbs and Context

## Status

Done

## Story

**As a** user,
**I want** clear navigation breadcrumbs and context when filtering by tags,
**so that** I always understand my current view and can easily return to previous states.

## Acceptance Criteria

1. Breadcrumb navigation showing current filter path (Home > Tag: urgent > Tag: project)
2. "Clear all filters" button prominently displayed when filters are active
3. Previous view restoration when removing individual filters
4. Current view context displayed in page title and header
5. Filter state visual indicators in main navigation menu
6. Quick filter shortcuts for frequently used tag combinations
7. Browser back/forward buttons work correctly with filter navigation

## Tasks / Subtasks

- [x] Task 1: Add Bootstrap breadcrumb to task list (AC: 1, 3)
  - [x] Add `<nav aria-label="breadcrumb">` above the status filter row in `task_list.html`
  - [x] When no tags active: render `Home / My Tasks` (Home links to `{% url 'home' %}`, "My Tasks" is the active/last item with no link)
  - [x] When tags active: render `Home / My Tasks / [tag badge 1] / [tag badge 2] ...` — each tag badge item links to `tag_remove_urls|get_item:tag.pk` (removes that individual tag from the filter); last tag item is marked `active` per Bootstrap breadcrumb spec
  - [x] Style breadcrumb tag items as colored badge links using existing inline style pattern: `style="background-color: {{ tag.color }}; color: {{ tag.color|badge_text_color }};"`; use `{% load task_tags %}` (already at top of template)

- [x] Task 2: Update page title to reflect active filter context (AC: 4)
  - [x] Override `{% block title %}` in `task_list.html` dynamically: when no tag filters → `My Tasks - Todo App`; when tags active → `My Tasks [tag1, tag2] - Todo App` (use template loop)
  - [x] The `<h1>` already shows `My Tasks (N)` when filtered — no change needed for h1

- [x] Task 3: Add navbar filter indicator badge (AC: 5)
  - [x] In `templates/includes/navbar.html`, on the "My Tasks" nav link: add a small yellow dot badge when the user is on `task-list` AND `"tags" in request.GET`
  - [x] Template condition: `{% if request.resolver_match.url_name == 'task-list' and "tags" in request.GET %}`
  - [x] Badge markup: `<span class="badge bg-warning text-dark ms-1" style="font-size: 0.65em;" title="Tag filters active">●</span>`
  - [x] The badge is only meaningful on the task-list page (filter params don't persist across pages)

- [x] Task 4: Add popular tags quick-filter chips (AC: 6)
  - [x] In `TaskListView.get_context_data()` in `apps/tasks/views.py`: add `popular_tags` — the top 5 user tags by task count (annotated with `num_tasks`, filtered `num_tasks__gt=0`, ordered by `"-num_tasks"`, sliced to `[:5]`)
  - [x] Reuse the existing `Count` import already present in `views.py`; `Tag` and `Count` already imported — no new imports needed
  - [x] In `task_list.html`, show popular tags as one-click chip buttons **only when no tag filters are currently active** (`{% if popular_tags and not active_tags %}`): render them as color-coded badge links using `tag_add_urls|get_item:tag.pk`
  - [x] Place the quick-filter section between the breadcrumb (Task 1) and the status filter row, with label "Quick filter:" in muted small text

- [x] Task 5: Write tests (AC: 1, 5, 6)
  - [ ] `TestTaskListViewPopularTags` in `apps/tasks/tests/test_views.py`:
    - [ ] `popular_tags` is in context (key present)
    - [ ] Tags are ordered by task count descending
    - [ ] Returns at most 5 tags
    - [ ] Only returns tags belonging to the authenticated user (not other users' tags)
    - [ ] Returns empty queryset when user has no tags with tasks
  - [x] `TestTaskListViewBreadcrumb` in `apps/tasks/tests/test_views.py`:
    - [x] When no tag filters: response context has empty `active_tags`
    - [x] When tag filters active: `active_tags` context contains the filtered tags (verifies breadcrumb data is correct)
    - [x] When tag filter active: `tag_remove_urls` context maps each active tag pk to a valid URL string (verifies individual removal links exist)

- [x] Task 6: Validate and verify (AC: 1–7)
  - [x] Run `ruff check .` with no errors
  - [x] Run `ruff format --check .` with no errors
  - [x] Run `pytest` with all tests passing
  - [x] Run `python manage.py check` with no issues
  - [x] Run `python manage.py makemigrations --check` — no new migrations expected

## Dev Notes

### Already Implemented — No Work Required

**AC3 (individual filter removal)** — Fully working. `tag_remove_urls` dict is already computed in `TaskListView.get_context_data()` and used in the active tag `alert-info` block. The breadcrumb (Task 1) will reuse these same URLs.

**AC7 (browser back/forward)** — Fully working. All filtering is URL-based (GET params `?tags=<uuid>&tags=<uuid>&tag_mode=and`). Browser navigation works naturally.

**AC2 ("Clear all filters" button)** — Already present inside the `alert-info` block in `task_list.html` as `<a href="{{ clear_tags_url }}" class="btn btn-sm btn-outline-secondary py-0">Clear all</a>`. No additional work needed; the breadcrumb's "My Tasks" link also serves as a one-click path back to the unfiltered view.

### Current `TaskListView.get_context_data()` — Context Already Available

[Source: `apps/tasks/views.py`]

The following context variables are already computed and available in `task_list.html`:

```python
context["active_tag_ids"]       # list of tag pk strings from GET param "tags"
context["active_tags"]          # QuerySet of Tag objects matching active_tag_ids
context["tag_mode"]             # "and" or "or"
context["tag_add_urls"]         # dict: str(tag.pk) → URL adding that tag to filter
context["tag_remove_urls"]      # dict: str(tag.pk) → URL removing that tag from filter
context["clear_tags_url"]       # URL with all tag params removed
context["toggle_tag_mode_url"]  # URL toggling AND/OR mode
context["task_total"]           # count of tasks matching current filter
context["user_tags"]            # all user tags (for sidebar)
context["page_base_params"]     # GET params without "page" (for pagination)
```

Add only `popular_tags` to this existing method.

### `popular_tags` Implementation

[Source: `apps/tasks/views.py` — `TagListView.get_queryset()` uses same `Count("tasks")` annotation pattern]

```python
# In TaskListView.get_context_data():
context["popular_tags"] = (
    Tag.objects.filter(user=self.request.user)
    .annotate(num_tasks=Count("tasks"))
    .filter(num_tasks__gt=0)
    .order_by("-num_tasks")[:5]
)
```

`Count` is already imported at the top of `views.py` (`from django.db.models import Case, Count, IntegerField, When`). `Tag` is also already imported. **No new imports needed.**

### Breadcrumb Template Implementation

[Source: Bootstrap 5.3 breadcrumb component — already included in base.html via CDN]

Place between the `<h1>` header block and the status filter row in `task_list.html`:

```django
<nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        {% if active_tags %}
        <li class="breadcrumb-item"><a href="{% url 'task-list' %}">My Tasks</a></li>
        {% for tag in active_tags %}
        <li class="breadcrumb-item {% if forloop.last %}active{% endif %}">
            <a href="{{ tag_remove_urls|get_item:tag.pk }}"
               class="badge text-decoration-none"
               style="background-color: {{ tag.color }}; color: {{ tag.color|badge_text_color }};"
               aria-label="Remove {{ tag.name }} filter">{{ tag.name }}</a>
        </li>
        {% endfor %}
        {% else %}
        <li class="breadcrumb-item active" aria-current="page">My Tasks</li>
        {% endif %}
    </ol>
</nav>
```

Note: The `get_item` template filter is already available (`{% load task_tags %}` is at the top of `task_list.html`). The `badge_text_color` filter is also already loaded.

### Page Title Template Block

[Source: `apps/tasks/templates/tasks/task_list.html` — current `{% block title %}My Tasks - Todo App{% endblock %}`]

Replace with:

```django
{% block title %}My Tasks{% if active_tags %} [{% for tag in active_tags %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}]{% endif %} - Todo App{% endblock %}
```

### Navbar Indicator Badge

[Source: `templates/includes/navbar.html` — "My Tasks" nav link]

**Note**: Match by content, not by line number — locate the anchor by searching for `href="{% url 'task-list' %}"` in `navbar.html`.

Current markup:
```html
<a class="nav-link {% if request.resolver_match.url_name == 'task-list' %}active{% endif %}" href="{% url 'task-list' %}">My Tasks</a>
```

Replace with:
```django
<a class="nav-link {% if request.resolver_match.url_name == 'task-list' %}active{% endif %}" href="{% url 'task-list' %}">
    My Tasks{% if request.resolver_match.url_name == 'task-list' and "tags" in request.GET %}<span class="badge bg-warning text-dark ms-1" style="font-size: 0.65em;" title="Tag filters active">●</span>{% endif %}
</a>
```

**Note**: `request` is available in `navbar.html` because `django.template.context_processors.request` is included in the project's TEMPLATES settings (standard Django setup). No view changes needed for the navbar.

### Quick Filter Chips Template

Place between the breadcrumb nav and the status filter row, inside the `{% block content %}`:

```django
{% if popular_tags and not active_tags %}
<div class="mb-2">
    <span class="text-muted small me-1">Quick filter:</span>
    {% for tag in popular_tags %}
    <a href="{{ tag_add_urls|get_item:tag.pk }}"
       class="badge text-decoration-none me-1"
       style="background-color: {{ tag.color }}; color: {{ tag.color|badge_text_color }};"
       title="{{ tag.num_tasks }} task{{ tag.num_tasks|pluralize }}">{{ tag.name }}</a>
    {% endfor %}
</div>
{% endif %}
```

Note: `tag_add_urls` is already in context (computed for all user tags). `num_tasks` is annotated on `popular_tags` query.

### File Locations

[Source: `docs/architecture/source-tree.md`]

Files to **modify**:
- `apps/tasks/views.py` — add `popular_tags` to `TaskListView.get_context_data()`
- `apps/tasks/templates/tasks/task_list.html` — add breadcrumb, update title block, add popular tags chips
- `templates/includes/navbar.html` — add filter indicator badge on "My Tasks" link
- `apps/tasks/tests/test_views.py` — add `TestTaskListViewPopularTags` and `TestTaskListViewBreadcrumb`

Files to **NOT modify**: models, migrations, `task_tags.py`, `urls.py`, other views.

### Testing

[Source: `docs/architecture/testing-strategy.md#View Tests`]

**Test file**: `apps/tasks/tests/test_views.py` — append new test classes

**Standards**:
- `@pytest.mark.django_db` on all classes
- Use `TagFactory`, `TaskFactory`, `UserFactory` from `apps/tasks/tests/factories.py`
- `client.force_login(user)` for auth
- 276 tests pass before this story

**Key test patterns**:

```python
@pytest.mark.django_db
class TestTaskListViewPopularTags:
    def test_popular_tags_in_context(self, client):
        user = UserFactory()
        tag = TagFactory(user=user)
        task = TaskFactory(user=user)
        task.tags.add(tag)
        client.force_login(user)
        response = client.get(reverse("task-list"))
        assert response.status_code == 200
        assert "popular_tags" in response.context

    def test_popular_tags_ordered_by_task_count_desc(self, client):
        user = UserFactory()
        tag_high = TagFactory(user=user)
        tag_low = TagFactory(user=user)
        TaskFactory.create_batch(3, user=user, tags=[tag_high])
        task = TaskFactory(user=user)
        task.tags.add(tag_low)
        client.force_login(user)
        response = client.get(reverse("task-list"))
        popular = list(response.context["popular_tags"])
        assert popular[0] == tag_high
        assert popular[1] == tag_low

    def test_popular_tags_limited_to_5(self, client):
        user = UserFactory()
        for _ in range(7):
            tag = TagFactory(user=user)
            task = TaskFactory(user=user)
            task.tags.add(tag)
        client.force_login(user)
        response = client.get(reverse("task-list"))
        assert len(list(response.context["popular_tags"])) <= 5

    def test_popular_tags_excludes_unused_tags(self, client):
        user = UserFactory()
        TagFactory(user=user)  # unused tag
        client.force_login(user)
        response = client.get(reverse("task-list"))
        assert len(list(response.context["popular_tags"])) == 0

    def test_popular_tags_excludes_other_users_tags(self, client):
        user = UserFactory()
        other_tag = TagFactory()  # different user
        other_task = TaskFactory(user=other_tag.user)
        other_task.tags.add(other_tag)
        client.force_login(user)
        response = client.get(reverse("task-list"))
        assert other_tag not in list(response.context["popular_tags"])

@pytest.mark.django_db
class TestTaskListViewBreadcrumb:
    def test_no_active_tags_when_no_filter(self, client):
        user = UserFactory()
        client.force_login(user)
        response = client.get(reverse("task-list"))
        assert len(list(response.context["active_tags"])) == 0

    def test_active_tags_in_context_when_filtered(self, client):
        user = UserFactory()
        tag = TagFactory(user=user)
        client.force_login(user)
        url = reverse("task-list") + f"?tags={tag.pk}"
        response = client.get(url)
        assert tag in response.context["active_tags"]

    def test_tag_remove_url_exists_for_active_tag(self, client):
        user = UserFactory()
        tag = TagFactory(user=user)
        client.force_login(user)
        url = reverse("task-list") + f"?tags={tag.pk}"
        response = client.get(url)
        remove_urls = response.context["tag_remove_urls"]
        assert str(tag.pk) in remove_urls
        assert isinstance(remove_urls[str(tag.pk)], str)
```

**Run tests**: `.venv/bin/pytest`
**Run linting**: `.venv/bin/ruff check . && .venv/bin/ruff format --check .`

### Previous Story Insights

From Story 2.5 (Tag Management Interface) Dev Agent Record:
- 276 tests pass at 99% coverage before this story
- `get_item` template filter in `apps/tasks/templatetags/task_tags.py`
- `badge_text_color` template filter also in `task_tags.py`
- `{% load task_tags %}` already at top of `task_list.html`
- `getCookie('csrftoken')` globally available from `static/js/base.js` (not needed for this story)
- `TAG_SORT_OPTIONS` placed at module level in `views.py`

From Story 2.4 (Tag-Based Task Filtering) Dev Agent Record:
- `_build_tag_add_url`, `_build_tag_remove_url`, `_build_clear_tags_url` helpers in `views.py`
- `TaskListView` filter/sort via GET params is established pattern
- `tag_add_urls`, `tag_remove_urls`, `clear_tags_url` are already in `TaskListView.get_context_data()` — do NOT recompute

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-6

### Completion Notes

- All 7 ACs implemented. AC2, AC3, AC7 were already done in prior stories — confirmed and verified, no changes needed.
- `popular_tags` query reuses existing `Count` import; no new imports or migrations required.
- Breadcrumb tag items with `active` class on `forloop.last` satisfy Bootstrap 5.3 breadcrumb spec correctly.
- Navbar badge uses `request.GET` check — only meaningful on task-list page as params don't persist across navigation.
- 8 new tests added (5 for popular_tags, 3 for breadcrumb context); 284 total passing at 99% coverage.

### Debug Log References

None.

### File List

- `apps/tasks/views.py` — added `popular_tags` to `TaskListView.get_context_data()`
- `apps/tasks/templates/tasks/task_list.html` — updated `{% block title %}`, added breadcrumb nav, added quick-filter chips
- `templates/includes/navbar.html` — added filter indicator badge on "My Tasks" link
- `apps/tasks/tests/test_views.py` — added `TestTaskListViewPopularTags` and `TestTaskListViewBreadcrumb`

## QA Results

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-19 | 0.1 | Initial story draft | SM Agent (Bob) |
| 2026-02-19 | 1.0 | Implementation complete | Dev Agent (James) |
