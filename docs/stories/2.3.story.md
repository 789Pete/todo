# Story 2.3: Color-Coded Visual Tag System

## Status

Ready for Review

## Story

**As a** user,
**I want** tags to have distinct colors for visual scanning and quick recognition,
**so that** I can rapidly identify task categories and relationships.

## Acceptance Criteria

1. Color picker interface for manual tag color assignment
2. Auto-assignment of contrasting colors for new tags to avoid duplication
3. Tag colors visible in task lists, forms, and all tag references
4. High contrast color combinations ensuring WCAG AA accessibility compliance
5. Color themes or palettes available for consistent visual organization
6. Tag color editing updates all instances immediately without page refresh
7. Export functionality includes tag color information for data portability

## Tasks / Subtasks

- [x] Task 1: Audit and verify tag color visibility across all views (AC: 3)
  - [x] Verify `task_list.html` renders tag badges with correct colors
  - [x] Verify `task_detail.html` renders tag badges with correct colors
  - [x] Verify `task_form.html` renders tag badge checkboxes with correct colors (already uses TAG_COLORS JSON)
  - [x] Verify `tag_list.html` shows color swatch and badge correctly
  - [x] Verify `tag_form.html` shows color RadioSelect swatches correctly
  - [x] Check that tag colors are injected via `tag_colors` JSON in `task_form.html` for JavaScript use
- [x] Task 2: Implement WCAG AA adaptive text color for tag badges (AC: 4)
  - [x] Add `get_badge_text_color(hex_color)` utility to `static/js/tag-autocomplete.js` — compute relative luminance using WCAG formula and return `'#000000'` or `'#ffffff'`
  - [x] Apply adaptive text color in all JavaScript-rendered tag badges (quick-create, autocomplete dropdown)
  - [x] Add Django template filter `badge_text_color` in `apps/tasks/templatetags/task_tags.py` that returns `"#000000"` or `"#ffffff"` based on luminance of the input hex color
  - [x] Create `apps/tasks/templatetags/__init__.py` if it does not exist
  - [x] Apply `badge_text_color` filter to all server-rendered tag badge spans in templates: `task_list.html`, `task_detail.html`, `tag_list.html`
  - [x] Load `{% load task_tags %}` at top of each template that uses the filter
- [x] Task 3: Add inline AJAX color editing to tag list (AC: 1, 6)
  - [x] Add a color swatch button to each tag row in `tag_list.html` — clicking opens an inline color picker (Bootstrap popover or small dropdown with the 8 palette swatches)
  - [x] Create `TagColorUpdateView` in `apps/tasks/views.py` — `LoginRequiredMixin`, `View`, POST-only, accepts `{"color": "#hex"}` JSON body, validates against `Tag.COLOR_CHOICES`, returns `{"color": "#hex"}` JSON — filters by `user=request.user` for ownership
  - [x] Add URL pattern `tags/<uuid:pk>/color/` → `tag-color-update` in `apps/tasks/urls.py`
  - [x] Add JavaScript in `tag_list.html` `{% block extra_js %}` to handle color swatch click → POST to `tag-color-update` → update badge and swatch in DOM without page reload
  - [x] Include CSRF token in AJAX request headers (`X-CSRFToken` from cookie)
  - [x] Show success/error feedback inline (Bootstrap alert or badge flash) after color update
- [x] Task 4: Add tag export functionality (AC: 7)
  - [x] Create `TagExportView` in `apps/tasks/views.py` — `LoginRequiredMixin`, `View`, GET-only, returns CSV response with headers: `name,color,task_count,created_at`
  - [x] Query user's tags with `annotate(num_tasks=Count("tasks"))` for task count (reuse existing queryset pattern from `TagListView`)
  - [x] Add URL pattern `tags/export/` → `tag-export` in `apps/tasks/urls.py`
  - [x] Add "Export CSV" button/link to `tag_list.html` (near "New Tag" button in the header row)
  - [x] Set response `Content-Type: text/csv` and `Content-Disposition: attachment; filename="tags.csv"`
- [x] Task 5: Write tests for new functionality (AC: 4, 6, 7)
  - [x] Test `badge_text_color` template filter: light colors return `#000000`, dark colors return `#ffffff`
  - [x] Test `TagColorUpdateView`: requires auth, validates color against `COLOR_CHOICES`, rejects other user's tags (404), returns updated JSON, rejects GET requests (405)
  - [x] Test `TagExportView`: requires auth, returns CSV with correct headers and data, only exports user's own tags, task_count is correct
  - [x] Add test for WCAG contrast validation logic (luminance calculation)
- [x] Task 6: Validate and verify (AC: 1-7)
  - [x] Run `ruff check .` with no errors
  - [x] Run `ruff format --check .` with no errors
  - [x] Run `pytest` with all tests passing
  - [x] Run `python manage.py check` with no issues
  - [x] Run `python manage.py makemigrations --check` — no new migrations expected

## Dev Notes

### Previous Story Insights

From Story 2.2 (Hybrid Tag Creation Workflow) Dev Agent Record:
- **Already implemented** — do NOT re-implement:
  - `TagForm` with RadioSelect color swatches (AC1 for tag create/edit form)
  - `_pick_auto_color()` helper that picks least-used color (AC2 fully covered)
  - Tag colors visible in all templates via `style="background-color: {{ tag.color }};"` (AC3 largely covered)
  - 8 `COLOR_CHOICES` palette serves as the color theme system (AC5 fully covered)
  - `tag-autocomplete.js` applies colors to JS-rendered badges
- **Known bug from 2.2**: `radio.data.value` must be used (not `radio.choice_label`) for hex codes in RadioSelect
- **Known pattern**: Tag colors injected as JSON via `mark_safe(json.dumps({str(tag.pk): tag.color ...}))` in `TaskForm.__init__` as `self.tag_colors`
- **Known pattern**: `{% load static %}` must be at top of template after `{% extends %}`
- All 210 tests pass, 99% overall coverage, views.py at 98%

### CRITICAL: What Story 2.3 Actually Adds (Net New)

Story 2.2 covered AC1, AC2, AC3 (partially), AC5. Story 2.3 focuses on:
- **AC4**: WCAG AA text contrast — badge text (white by default via Bootstrap `.badge`) fails contrast on light colors: `#F7DC6F` (Yellow), `#98D8C8` (Mint), `#85C1E2` (Sky Blue) — need adaptive text color
- **AC6**: Inline real-time color editing on tag list page (currently requires navigate → form → submit → redirect)
- **AC7**: Export tags as CSV including color field
- **AC3 completion**: Ensure ALL badge instances use the WCAG-safe text color (server-rendered templates + JavaScript-rendered)

### Tag Model — What Exists

[Source: architecture/data-models.md#Tag Model]

```python
COLOR_CHOICES = [
    ('#FF6B6B', 'Red'),
    ('#4ECDC4', 'Teal'),
    ('#45B7D1', 'Blue'),
    ('#FFA07A', 'Orange'),
    ('#98D8C8', 'Mint'),
    ('#F7DC6F', 'Yellow'),
    ('#BB8FCE', 'Purple'),
    ('#85C1E2', 'Sky Blue'),
]
```

Fields: `id` (UUID PK), `user` (FK CASCADE), `name` (CharField max 50), `color` (CharField max 7, choices), `created_at` (auto_now_add).

Tag names unique per user (case-insensitive). Max 50 chars. Color must be valid hex from COLOR_CHOICES.

### WCAG AA Contrast Implementation

**WCAG formula for relative luminance**:
```javascript
function getLuminance(hex) {
    const r = parseInt(hex.slice(1, 3), 16) / 255;
    const g = parseInt(hex.slice(3, 5), 16) / 255;
    const b = parseInt(hex.slice(5, 7), 16) / 255;
    const toLinear = c => c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
    return 0.2126 * toLinear(r) + 0.7152 * toLinear(g) + 0.0722 * toLinear(b);
}

function getBadgeTextColor(hex) {
    const lum = getLuminance(hex);
    // WCAG AA: contrast ratio >= 4.5:1 for normal text
    // White (#fff) luminance = 1.0, Black (#000) luminance = 0.0
    // Use white text if luminance < 0.179 (threshold for 4.5:1 against black)
    return lum > 0.179 ? '#000000' : '#ffffff';
}
```

**Python equivalent for template tag**:
```python
def badge_text_color(hex_color):
    """Return '#000000' or '#ffffff' for WCAG AA contrast on hex_color background."""
    hex_color = hex_color.lstrip('#')
    r, g, b = int(hex_color[0:2], 16) / 255, int(hex_color[2:4], 16) / 255, int(hex_color[4:6], 16) / 255
    def to_linear(c):
        return c / 12.92 if c <= 0.03928 else ((c + 0.055) / 1.055) ** 2.4
    lum = 0.2126 * to_linear(r) + 0.7152 * to_linear(g) + 0.0722 * to_linear(b)
    return '#000000' if lum > 0.179 else '#ffffff'
```

Applied results for current 8 colors:
- `#FF6B6B` Red → white text ✓
- `#4ECDC4` Teal → white text ✓
- `#45B7D1` Blue → white text ✓
- `#FFA07A` Orange → dark text (needs fix)
- `#98D8C8` Mint → dark text (needs fix)
- `#F7DC6F` Yellow → dark text (needs fix)
- `#BB8FCE` Purple → white text ✓
- `#85C1E2` Sky Blue → dark text (needs fix)

### Template Tag Pattern

[Source: architecture/source-tree.md#Application Structure]

Create `apps/tasks/templatetags/` directory:
```
apps/tasks/templatetags/
├── __init__.py
└── task_tags.py
```

Django template tags must be in a `templatetags/` package inside the app. The app must be in `INSTALLED_APPS` (it is: `apps.tasks`).

Usage in template:
```django
{% load task_tags %}
<span class="badge"
      style="background-color: {{ tag.color }}; color: {{ tag.color|badge_text_color }};">
    {{ tag.name }}
</span>
```

### Inline Color Update AJAX Endpoint

New view: `TagColorUpdateView` (POST JSON):
- URL: `tasks/tags/<uuid:pk>/color/`
- Auth: `LoginRequiredMixin`
- Method: POST only (`http_method_names = ["post"]`)
- Request body: `{"color": "#4ECDC4"}`
- Validate color is in `Tag.COLOR_CHOICES` values
- Filter: `Tag.objects.filter(pk=pk, user=request.user)` — 404 if not found
- Response: `{"color": "#4ECDC4"}` on success (200), `{"error": "..."}` on failure (400)
- Pattern: consistent with `TagQuickCreateView` AJAX pattern from Story 2.2

JavaScript flow for inline color picker on tag list:
1. Each tag row has a clickable color swatch
2. Click shows a small popover/dropdown with 8 color swatches
3. Clicking a swatch POSTs to `tag-color-update` with CSRF token
4. On success: update the badge background-color and text color, update the swatch in the table row

### CSV Export Pattern

New view: `TagExportView` (GET):
- URL: `tasks/tags/export/`
- Auth: `LoginRequiredMixin`
- Returns: CSV file download
- Data: user's tags with `annotate(num_tasks=Count("tasks"))`, ordered by name

```python
import csv
from django.http import HttpResponse

class TagExportView(LoginRequiredMixin, View):
    http_method_names = ["get"]

    def get(self, request):
        response = HttpResponse(content_type="text/csv")
        response["Content-Disposition"] = 'attachment; filename="tags.csv"'
        writer = csv.writer(response)
        writer.writerow(["name", "color", "task_count", "created_at"])
        tags = Tag.objects.filter(user=request.user).annotate(
            num_tasks=Count("tasks")
        ).order_by("name")
        for tag in tags:
            writer.writerow([tag.name, tag.color, tag.num_tasks, tag.created_at.isoformat()])
        return response
```

### URL Ordering — CRITICAL

[Source: Story 2.2 implementation, apps/tasks/urls.py]

When adding `tags/export/` and `tags/<uuid:pk>/color/`, **static paths must come before UUID patterns** to avoid URL conflicts. Current tag URL order in `urls.py`:
```python
path("tags/", ...),
path("tags/create/", ...),
path("tags/quick-create/", ...),   # static — before UUID patterns
path("tags/autocomplete/", ...),   # static — before UUID patterns
path("tags/bulk-edit/", ...),      # static — before UUID patterns
path("tags/export/", ...),         # ADD THIS before UUID patterns
path("tags/<uuid:pk>/edit/", ...),
path("tags/<uuid:pk>/delete/", ...),
path("tags/<uuid:pk>/color/", ...),  # ADD THIS after static paths
```

### File Locations

[Source: architecture/source-tree.md]

Files to create:
- `apps/tasks/templatetags/__init__.py` — make it a package
- `apps/tasks/templatetags/task_tags.py` — `badge_text_color` filter

Files to modify:
- `apps/tasks/views.py` — add `TagColorUpdateView`, `TagExportView`
- `apps/tasks/urls.py` — add `tag-color-update`, `tag-export` URL patterns
- `apps/tasks/templates/tasks/tag_list.html` — add inline color editing UI, export button, load task_tags
- `apps/tasks/templates/tasks/task_list.html` — load task_tags, apply badge_text_color
- `apps/tasks/templates/tasks/task_detail.html` — load task_tags, apply badge_text_color
- `static/js/tag-autocomplete.js` — add `getBadgeTextColor()` and apply to JS-rendered badges
- `apps/tasks/tests/test_views.py` — add tests for new views
- `apps/tasks/tests/test_forms.py` or new `test_template_tags.py` — test the filter

### Testing

[Source: architecture/testing-strategy.md]

**Test file locations**:
- `apps/tasks/tests/test_views.py` — add `TestTagColorUpdateView`, `TestTagExportView`
- `apps/tasks/tests/test_template_tags.py` — new file for `badge_text_color` filter tests

**Test standards**:
- Use `@pytest.mark.django_db`
- Use `TagFactory`, `TaskFactory`, `UserFactory`
- For CSV export: check `response["Content-Type"]`, check `response["Content-Disposition"]`, decode and parse response content
- For color update AJAX: POST JSON with `content_type="application/json"`, check 200 vs 400, verify DB updated
- For template tag: call `badge_text_color()` directly with known hex values, assert expected return

**Run tests**: `.venv/bin/pytest`
**Run linting**: `.venv/bin/ruff check . && .venv/bin/ruff format --check .`

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-6

### Completion Notes

- Story doc's "Applied results" table was incorrect: all 8 palette colors have luminance > 0.179 → all return dark text (#000000). This is WCAG-correct: all palette colors are medium-to-light, so dark text provides higher contrast than white. Tests updated to reflect actual formula output.
- `TagExportView` and `TagColorUpdateView` added to views.py; URL ordering preserved (static paths before UUID patterns).
- Inline color picker implemented as a simple popover div (no Bootstrap dependency) with 8 swatches per row in tag_list.html.
- `getLuminance`/`getBadgeTextColor` added as module-level functions in tag-autocomplete.js (outside DOMContentLoaded) so they're globally available. Also duplicated in tag_list.html's inline `<script>` block.
- WCAG AA formula verified: threshold 0.179 = luminance below which black text fails 4.5:1 contrast ratio.

### Debug Log References

None.

### File List

**Created:**
- `apps/tasks/templatetags/__init__.py`
- `apps/tasks/templatetags/task_tags.py`
- `apps/tasks/tests/test_template_tags.py`

**Modified:**
- `apps/tasks/views.py` — added `TagExportView`, `TagColorUpdateView`, `import csv`, `HttpResponse`
- `apps/tasks/urls.py` — added `tag-export`, `tag-color-update` URL patterns
- `apps/tasks/templates/tasks/tag_list.html` — added Export button, inline color picker UI + AJAX JS, badge_text_color filter
- `apps/tasks/templates/tasks/task_list.html` — added `{% load task_tags %}`, applied `badge_text_color` filter to tag badges
- `apps/tasks/templates/tasks/task_detail.html` — added `{% load task_tags %}`, applied `badge_text_color` filter to tag badges
- `static/js/tag-autocomplete.js` — added `getLuminance()`, `getBadgeTextColor()` functions, applied adaptive text color to all JS-rendered badges
- `apps/tasks/tests/test_views.py` — added `TestTagColorUpdateView` (6 tests), `TestTagExportView` (7 tests)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-18 | 0.1 | Initial story draft | SM Agent (Bob) |
