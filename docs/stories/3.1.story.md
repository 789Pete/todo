# Story 3.1: JavaScript Visualization Library Integration

## Status

Done

## Story

**As a** developer,
**I want** to integrate and configure a robust JavaScript visualization library,
**so that** the application can render interactive network graphs performantly.

## Acceptance Criteria

1. Research and selection between D3.js, vis.js, or similar libraries based on performance and features
2. Library integration with Django templates and static asset management
3. Basic network graph rendering with nodes and edges functionality
4. Graph canvas responsive to container size changes and window resizing
5. Touch and mouse interaction event handling for nodes and connections
6. Performance testing with 100+ nodes and 200+ edges without lag
7. Fallback error handling when JavaScript is disabled or library fails to load

## Tasks / Subtasks

- [x] Task 1: Download and vendor vis-network library (AC: 1, 2)
  - [x] Create `static/js/vendor/` directory
  - [x] Download vis-network 9.x standalone UMD bundle to `static/js/vendor/vis-network.min.js`:
    ```bash
    mkdir -p static/js/vendor
    curl -L -o static/js/vendor/vis-network.min.js \
      "https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"
    ```
  - [x] Verify file downloaded successfully (should be ~1MB)

- [x] Task 2: Create visualization app test structure (AC: 2)
  - [x] Create `apps/visualization/tests/` directory with `__init__.py`
  - [x] Delete placeholder `apps/visualization/tests.py` (replaced by tests/ folder)
  - [x] Create `apps/visualization/tests/test_views.py` (initially empty, populated in Task 8)

- [x] Task 3: Create GraphView and URL (AC: 2)
  - [x] Add `GraphView(LoginRequiredMixin, TemplateView)` to `apps/visualization/views.py`
    - `template_name = "visualization/graph.html"`
    - Import: `from django.contrib.auth.mixins import LoginRequiredMixin`
    - Import: `from django.views.generic import TemplateView`
  - [x] Update `apps/visualization/urls.py` with URL pattern:
    - Import `GraphView` and `path`
    - Add `path("", GraphView.as_view(), name="graph-view")`

- [x] Task 4: Create graph template (AC: 2, 3, 4, 7)
  - [x] Create directory `apps/visualization/templates/visualization/`
  - [x] Create `apps/visualization/templates/visualization/graph.html` extending `base.html`
  - [x] Add `{% block extra_css %}` with link to `{% static 'css/graph.css' %}`
  - [x] Add `<h1>` page heading: "Task Network Graph"
  - [x] Add `<div id="network-graph" class="graph-container"></div>` — exact ID required for E2E tests
  - [x] Add `<noscript>` fallback block with Bootstrap warning alert (AC: 7)
  - [x] Add `{% block extra_js %}` with scripts:
    1. `{% static 'js/vendor/vis-network.min.js' %}` (must load before graph-viewer.js)
    2. `{% static 'js/graph-viewer.js' %}`
  - [x] Use `{% load static %}` at top of template

- [x] Task 5: Create graph-viewer.js (AC: 3, 4, 5, 6)
  - [x] Create `static/js/graph-viewer.js`
  - [x] On `DOMContentLoaded`: check `#network-graph` container exists (safety check)
  - [x] Wrap entire initialization in `try/catch` — on error, show error message inside container (AC: 7)
  - [x] Define sample nodes and edges (5 nodes: 3 tasks + 2 tags, 3 edges) matching Story 3.2 API format
  - [x] Initialize `vis.Network` with `vis.DataSet` for nodes and edges
  - [x] Configure interaction options: `zoomView: true`, `dragView: true`, `dragNodes: true`, `tooltipDelay: 200` (AC: 5 — touch and mouse events are native to vis-network)
  - [x] Configure physics: `enabled: true`, `stabilization: { iterations: 100, fit: true }`
  - [x] Add `window.addEventListener('resize', ...)` calling `network.setSize('100%', ...)` and `network.fit()` (AC: 4)
  - [x] Expose `window.testGraphPerformance()` function that loads 110 nodes + 210 edges and logs render time to console (AC: 6)

- [x] Task 6: Create graph.css (AC: 4)
  - [x] Create `static/css/graph.css`
  - [x] Style `.graph-container`: `width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 0.375rem; background-color: #ffffff;`
  - [x] Add responsive media query: `@media (max-width: 768px)` → `height: 400px`

- [x] Task 7: Add "Graph" navbar link (AC: 2)
  - [x] In `templates/includes/navbar.html`, add a new `<li class="nav-item">` after the "My Tags" nav item (inside `{% if user.is_authenticated %}` block):
    ```html
    <li class="nav-item">
        <a class="nav-link {% if request.resolver_match.url_name == 'graph-view' %}active{% endif %}"
           href="{% url 'graph-view' %}">Graph</a>
    </li>
    ```

- [x] Task 8: Write tests (AC: 1-7)
  - [x] Populate `apps/visualization/tests/test_views.py` with `TestGraphView`:
    - [x] `test_graph_view_requires_authentication` — unauthenticated GET → 302 redirect with `/login/` in URL
    - [x] `test_graph_view_returns_200_for_authenticated_user` — force login → 200 OK
    - [x] `test_graph_view_uses_correct_template` — template name `visualization/graph.html` in response templates
    - [x] `test_graph_view_contains_graph_container` — `b'id="network-graph"'` in `response.content`

- [x] Task 9: Validate and verify (AC: 1-7)
  - [x] Run `ruff check .` with no errors
  - [x] Run `ruff format --check .` with no errors
  - [x] Run `pytest` with all tests passing
  - [x] Run `python manage.py check` with no issues
  - [x] Run `python manage.py makemigrations --check` — no new migrations expected
  - [ ] Manual: Load `/visualization/` in browser; verify graph canvas renders with 5 sample nodes and 3 edges
  - [ ] Manual: Resize browser window; verify canvas reflows correctly
  - [ ] Manual: Open browser console, run `testGraphPerformance()`; verify no browser freeze and timing logged

## Dev Notes

### AC1 Already Resolved — Library Decision Pre-Made

The architecture has already evaluated and selected **vis-network 9.x** over D3.js and others. The dev agent does NOT need to re-research this decision — implement vis-network as specified.

**Why vis-network was chosen** [Source: architecture/tech-stack.md#Complete Stack Table]:

| Criteria | vis-network | D3.js |
|----------|------------|-------|
| Graph-specific API | ✅ Purpose-built for networks | ❌ Low-level, more boilerplate |
| Touch support | ✅ Built-in native support | ❌ Manual implementation required |
| Performance (100+ nodes) | ✅ Optimized for graph rendering | ⚠️ Needs custom optimization |
| Django integration | ✅ Simple vendor file | ✅ Simple vendor file |

vis-network exposes global `vis` object from standalone UMD bundle. No npm/build step required.

### Visualization App — Current State

The `apps/visualization` app **exists and is registered** in `INSTALLED_APPS` and root `urls.py`, but is **completely empty**:

```
apps/visualization/
├── __init__.py
├── apps.py       ← name = "apps.visualization" ✅ already correct
├── admin.py      ← empty, no changes needed
├── migrations/   ← no models, no migrations needed
├── models.py     ← empty, no models for this story
├── tests.py      ← DELETE this — replace with tests/ directory
├── urls.py       ← urlpatterns = []  ← ADD graph-view URL
└── views.py      ← empty  ← ADD GraphView
```

Templates directory does NOT exist yet — create it:
```
apps/visualization/templates/visualization/graph.html
```

[Source: architecture/source-tree.md#Application Structure]

### URL Routing — Already Wired in Root

`todo_project/urls.py` already has:
```python
path("visualization/", include("apps.visualization.urls")),
```

Adding `path("", GraphView.as_view(), name="graph-view")` to `apps/visualization/urls.py` makes graph available at `/visualization/`.

[Source: `todo_project/urls.py`]

### Static File Locations

[Source: architecture/source-tree.md#Static Files Organization]

```
static/
├── css/
│   ├── base.css           ← exists, do not modify
│   └── graph.css          ← CREATE
├── js/
│   ├── base.js            ← exists, do not modify
│   ├── tag-autocomplete.js ← exists, do not modify
│   └── vendor/
│       └── vis-network.min.js  ← DOWNLOAD (see Task 1)
```

`graph-viewer.js` goes at `static/js/graph-viewer.js` (not in vendor/).

### GraphView Implementation

[Source: architecture/coding-standards.md#View Best Practices, architecture/source-tree.md]

```python
# apps/visualization/views.py
from django.contrib.auth.mixins import LoginRequiredMixin
from django.views.generic import TemplateView


class GraphView(LoginRequiredMixin, TemplateView):
    template_name = "visualization/graph.html"
```

```python
# apps/visualization/urls.py
from django.urls import path

from apps.visualization.views import GraphView

urlpatterns = [
    path("", GraphView.as_view(), name="graph-view"),
]
```

### Graph Template Implementation

[Source: `templates/base.html` — confirmed blocks: `extra_css`, `content`, `extra_js`, `title`]

```django
{% extends "base.html" %}
{% load static %}

{% block title %}Network Graph - Todo App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/graph.css' %}">
{% endblock %}

{% block content %}
<h1 class="h3 mb-3">Task Network Graph</h1>

{# Graph container — ID "network-graph" is required by E2E tests #}
<div id="network-graph" class="graph-container"></div>

{# AC7: Fallback for users with JavaScript disabled #}
<noscript>
    <div class="alert alert-warning mt-3" role="alert">
        The network graph requires JavaScript. Please enable JavaScript in your browser to view the visualization.
    </div>
</noscript>
{% endblock %}

{% block extra_js %}
{# vis-network must load before graph-viewer.js #}
<script src="{% static 'js/vendor/vis-network.min.js' %}"></script>
<script src="{% static 'js/graph-viewer.js' %}"></script>
{% endblock %}
```

### graph-viewer.js Implementation

[Source: architecture/high-level-architecture.md#Graph Visualization Flow, architecture/api-specification.md#Get Graph Data]

The Story 3.2 API (`GET /api/graph/data/`) will return nodes/edges in this exact format. Story 3.1 uses hardcoded sample data matching the same structure so Story 3.2 can easily replace it with an API fetch.

**Node color groups** [Source: architecture/api-specification.md#Node Types]:
- Task `todo`: `background: '#e3f2fd'`, `border: '#2196f3'` (blue)
- Task `in_progress`: `background: '#fff8e1'`, `border: '#ff9800'` (yellow/amber)
- Task `done`: `background: '#e8f5e9'`, `border: '#4caf50'` (green)
- Tag: `background` = tag's color field value, `border` = darker border

```javascript
// static/js/graph-viewer.js
// Story 3.1: Uses sample data. Story 3.2 will replace with /api/graph/data/ fetch.

document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('network-graph');
    if (!container) return;  // Safety: container not present on this page

    try {
        // Sample data matching Story 3.2 API format
        const sampleNodes = [
            {
                id: 'task-1', label: 'Complete project\nproposal', group: 'todo', shape: 'box',
                color: { background: '#e3f2fd', border: '#2196f3' }, title: 'Priority: high'
            },
            {
                id: 'task-2', label: 'Review security\naudit', group: 'in_progress', shape: 'box',
                color: { background: '#fff8e1', border: '#ff9800' }, title: 'Priority: medium'
            },
            {
                id: 'task-3', label: 'Write tests', group: 'done', shape: 'box',
                color: { background: '#e8f5e9', border: '#4caf50' }, title: 'Priority: low'
            },
            {
                id: 'tag-1', label: 'Work', group: 'tag', shape: 'ellipse',
                color: { background: '#FF6B6B', border: '#d32f2f' }, title: '2 tasks'
            },
            {
                id: 'tag-2', label: 'Personal', group: 'tag', shape: 'ellipse',
                color: { background: '#4ECDC4', border: '#00897b' }, title: '1 task'
            },
        ];

        const sampleEdges = [
            { from: 'task-1', to: 'tag-1', color: '#999999', width: 1 },
            { from: 'task-2', to: 'tag-1', color: '#999999', width: 1 },
            { from: 'task-3', to: 'tag-2', color: '#999999', width: 1 },
        ];

        const data = {
            nodes: new vis.DataSet(sampleNodes),
            edges: new vis.DataSet(sampleEdges),
        };

        const options = {
            nodes: { font: { size: 12 } },
            edges: {
                color: { color: '#999999' },
                smooth: { type: 'continuous' },
            },
            physics: {
                enabled: true,
                stabilization: { iterations: 100, fit: true },
            },
            interaction: {
                // AC5: touch and mouse events — native to vis-network, enabled by default
                zoomView: true,
                dragView: true,
                dragNodes: true,
                tooltipDelay: 200,
                multiselect: false,
            },
            layout: { improvedLayout: true },
        };

        const network = new vis.Network(container, data, options);

        // AC4: Responsive canvas on window resize
        window.addEventListener('resize', function () {
            network.setSize('100%', container.offsetHeight + 'px');
            network.fit();
        });

        // AC6: Performance test helper — call window.testGraphPerformance() in console
        window.testGraphPerformance = function () {
            const perfNodes = [];
            const perfEdges = [];
            for (let i = 0; i < 110; i++) {
                perfNodes.push({ id: 'p-' + i, label: 'Node ' + i, shape: 'box' });
            }
            for (let j = 0; j < 210; j++) {
                perfEdges.push({ from: 'p-' + (j % 110), to: 'p-' + ((j + 1) % 110) });
            }
            const start = performance.now();
            network.setData({
                nodes: new vis.DataSet(perfNodes),
                edges: new vis.DataSet(perfEdges),
            });
            network.once('stabilized', function () {
                const elapsed = performance.now() - start;
                console.log(
                    'Performance: ' + perfNodes.length + ' nodes, ' +
                    perfEdges.length + ' edges stabilized in ' + elapsed.toFixed(0) + 'ms'
                );
                network.setData(data);  // Restore sample data
            });
        };

    } catch (e) {
        // AC7: Error fallback when vis-network fails
        console.error('Graph initialization failed:', e);
        container.innerHTML =
            '<div class="alert alert-danger m-3">' +
            'Failed to load the graph visualization. Please refresh the page.' +
            '</div>';
    }
});
```

### graph.css Implementation

```css
/* static/css/graph.css */
.graph-container {
    width: 100%;
    height: 600px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #ffffff;
    position: relative;
}

@media (max-width: 768px) {
    .graph-container {
        height: 400px;
    }
}
```

### Navbar Link Insertion

[Source: `templates/includes/navbar.html` — current structure]

Insert new `<li>` after the existing "My Tags" nav item (inside the `{% if user.is_authenticated %}` block). The navbar currently has: Home, My Tasks, My Tags, Profile, username display, Logout.

Add after the "My Tags" `<li>`:
```html
<li class="nav-item">
    <a class="nav-link {% if request.resolver_match.url_name == 'graph-view' %}active{% endif %}"
       href="{% url 'graph-view' %}">Graph</a>
</li>
```

### vis-network Touch/Mouse Events (AC5)

vis-network handles touch and mouse events natively through the browser's pointer event system. No additional event handlers are needed — the interaction options `zoomView`, `dragView`, `dragNodes` in the `options` object activate these capabilities automatically for both mouse and touch devices.

[Source: architecture/tech-stack.md#Browser Support Matrix — Mobile Safari iOS 14+ and Mobile Chrome Android 90+ listed as supported]

### Testing

[Source: architecture/testing-strategy.md#View Tests]

**Test file**: `apps/visualization/tests/test_views.py` — new file (create `tests/` directory and `__init__.py` first)

**Standards**:
- `@pytest.mark.django_db` on all classes
- Use `UserFactory` from `apps/tasks/tests/factories.py`
- `client.force_login(user)` for auth (not `client.login()`)
- 284 tests pass before this story

```python
# apps/visualization/tests/test_views.py
import pytest
from django.urls import reverse

from apps.tasks.tests.factories import UserFactory


@pytest.mark.django_db
class TestGraphView:
    def test_graph_view_requires_authentication(self, client):
        url = reverse("graph-view")
        response = client.get(url)
        assert response.status_code == 302
        assert "/login/" in response.url

    def test_graph_view_returns_200_for_authenticated_user(self, client):
        user = UserFactory()
        client.force_login(user)
        url = reverse("graph-view")
        response = client.get(url)
        assert response.status_code == 200

    def test_graph_view_uses_correct_template(self, client):
        user = UserFactory()
        client.force_login(user)
        url = reverse("graph-view")
        response = client.get(url)
        assert "visualization/graph.html" in [t.name for t in response.templates]

    def test_graph_view_contains_graph_container(self, client):
        user = UserFactory()
        client.force_login(user)
        url = reverse("graph-view")
        response = client.get(url)
        assert b'id="network-graph"' in response.content
```

**Run tests**: `.venv/bin/pytest`
**Run linting**: `.venv/bin/ruff check . && .venv/bin/ruff format --check .`

### File Locations Summary

[Source: architecture/source-tree.md]

Files to **create**:
- `static/js/vendor/vis-network.min.js` — download from CDN (Task 1)
- `static/js/graph-viewer.js` — vis-network initialization (Task 5)
- `static/css/graph.css` — graph container styles (Task 6)
- `apps/visualization/templates/visualization/graph.html` — graph page template (Task 4)
- `apps/visualization/tests/__init__.py` — package marker (Task 2)
- `apps/visualization/tests/test_views.py` — view tests (Tasks 2, 8)

Files to **modify**:
- `apps/visualization/views.py` — add `GraphView` (Task 3)
- `apps/visualization/urls.py` — add `graph-view` URL (Task 3)
- `templates/includes/navbar.html` — add "Graph" nav link (Task 7)

Files to **delete**:
- `apps/visualization/tests.py` — replaced by `tests/` directory (Task 2)

Files to **NOT modify**: models, migrations, root `urls.py`, settings, tasks app files

No new Python packages required (vis-network is a JavaScript library served as a static file).
No database migrations required (visualization app has no models).

### Previous Story Insights

From Story 2.6 (Navigation Breadcrumbs) Dev Agent Record:
- 284 tests pass at 99% coverage before this story
- `getCookie('csrftoken')` available globally from `static/js/base.js` (not needed for story 3.1)
- `request` is available in templates via context processor — no changes needed for navbar `request.resolver_match` checks
- Pattern for nav active class: `{% if request.resolver_match.url_name == 'url-name' %}active{% endif %}`

From Epic 3 Architecture Context:
- `apps/visualization` URL is at `/visualization/` (wired in root `urls.py`)
- Graph canvas `#network-graph` must keep this exact DOM ID — referenced in architecture E2E test examples
- The graph template should be at `apps/visualization/templates/visualization/graph.html` matching Django app template namespacing convention

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-6

### Completion Notes List

- `UserFactory` is in `apps.accounts.tests.factories`, not `apps.tasks.tests.factories` — corrected import in test file.
- vis-network 9.1.9 downloaded at 673KB (not ~1MB as noted in story; file is valid UMD bundle).
- 288 tests pass (284 baseline + 4 new visualization view tests) at 99% coverage.

### Debug Log References

None.

### File List

**Created:**
- `static/js/vendor/vis-network.min.js`
- `static/js/graph-viewer.js`
- `static/css/graph.css`
- `apps/visualization/templates/visualization/graph.html`
- `apps/visualization/tests/__init__.py`
- `apps/visualization/tests/test_views.py`

**Modified:**
- `apps/visualization/views.py`
- `apps/visualization/urls.py`
- `templates/includes/navbar.html`

**Deleted:**
- `apps/visualization/tests.py`

## QA Results

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-19 | 0.1 | Initial story draft | SM Agent (Bob) |
