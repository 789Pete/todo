# Story 1.1: Project Setup and Django Configuration

## Status

Done

## Story

**As a** developer,
**I want** a properly configured Django project with all necessary dependencies,
**so that** I have a solid foundation for building the todo application.

## Acceptance Criteria

1. Django 4.x project created with proper settings for development and production
2. PostgreSQL database configured and connected
3. Virtual environment setup with requirements.txt containing all dependencies
4. Git repository initialized with proper .gitignore for Django projects
5. Basic CI/CD pipeline configured for automated testing
6. Environment-based configuration for secure deployment to PythonAnywhere
7. Health check endpoint returns 200 status confirming app deployment

## Tasks / Subtasks

- [x] Task 1: Initialize Django project structure (AC: 1)
  - [x] Create Django project named `todo_project` with `django-admin startproject`
  - [x] Create split settings directory: `todo_project/settings/` with `__init__.py`, `base.py`, `development.py`, `production.py`, `test.py`
  - [x] Configure `base.py` with common settings: INSTALLED_APPS, MIDDLEWARE, TEMPLATES, AUTH_PASSWORD_VALIDATORS, timezone (UTC), static files
  - [x] Configure `development.py` with `DEBUG=True`, verbose logging, Django Debug Toolbar
  - [x] Configure `production.py` with `DEBUG=False`, security settings (SECURE_SSL_REDIRECT, HSTS, etc.), WhiteNoise for static files, Sentry integration
  - [x] Configure `test.py` with SQLite in-memory database, faster password hashing
  - [x] Create `manage.py` pointing to `todo_project.settings.development` by default

- [x] Task 2: Create Django apps scaffolding (AC: 1)
  - [x] Create `apps/` directory
  - [x] Create `apps/accounts/` app via `python manage.py startapp accounts apps/accounts`
  - [x] Create `apps/tasks/` app via `python manage.py startapp tasks apps/tasks`
  - [x] Create `apps/visualization/` app via `python manage.py startapp visualization apps/visualization`
  - [x] Register all three apps in `INSTALLED_APPS` in `base.py`

- [x] Task 3: Setup dependency management with uv (AC: 3)
  - [x] Create `requirements/` directory with `base.in`, `production.in`, `development.in`
  - [x] Populate `base.in` with core deps: `Django>=4.2,<4.3`, `djangorestframework>=3.14,<4.0`, `psycopg2-binary>=2.9,<3.0`, `argon2-cffi>=23.1,<24.0`, `whitenoise>=6.6,<7.0`
  - [x] Populate `production.in` extending base: `sentry-sdk>=1.40,<2.0`, `gunicorn`
  - [x] Populate `development.in` extending production: `pytest>=7.4`, `pytest-django`, `pytest-cov>=4.1`, `factory-boy>=3.3`, `ruff>=0.1.9`, `pre-commit`, `django-debug-toolbar`
  - [x] Compile all requirement files using `uv pip compile`
  - [x] Create virtual environment and install development dependencies

- [x] Task 4: Configure PostgreSQL database connection (AC: 2)
  - [x] Add `DATABASE_URL` parsing in `base.py` (use `dj-database-url` or manual parsing from env var)
  - [x] Configure database settings to read from environment variable `DATABASE_URL`
  - [x] Ensure `test.py` overrides to use SQLite for fast test execution
  - [x] Verify database connection with `python manage.py check --database default`

- [x] Task 5: Setup environment configuration (AC: 6)
  - [x] Create `.env.example` with all required environment variables (SECRET_KEY, DEBUG, ALLOWED_HOSTS, DATABASE_URL, EMAIL_*, SENTRY_DSN, PYTHONANYWHERE_*)
  - [x] Create `.env` for local development (add to .gitignore if not already)
  - [x] Install `python-dotenv` or `django-environ` for .env file loading
  - [x] Configure `wsgi.py` to load environment variables
  - [x] Generate and set a `SECRET_KEY` for development

- [x] Task 6: Configure project-level Python tooling (AC: 1)
  - [x] Create `pyproject.toml` with project metadata, ruff config (line-length=88, target-version="py310", lint select E/W/F/I/DJ/N/UP/C90), and pytest config (DJANGO_SETTINGS_MODULE=todo_project.settings.test, testpaths, addopts with coverage)
  - [x] Create `.pre-commit-config.yaml` with ruff hooks (ruff check --fix, ruff-format)
  - [x] Install pre-commit hooks via `pre-commit install`

- [x] Task 7: Create global templates and static file structure (AC: 1)
  - [x] Create `templates/` directory with `base.html`, `home.html`, `404.html`, `500.html`
  - [x] Create `templates/includes/` with `navbar.html`, `footer.html`
  - [x] Create `static/css/base.css`, `static/js/base.js`, `static/images/` directories
  - [x] Configure `STATICFILES_DIRS` and `STATIC_ROOT` in base settings
  - [x] Configure template directories in `TEMPLATES` setting

- [x] Task 8: Create root URL configuration (AC: 1, 7)
  - [x] Configure `todo_project/urls.py` with URL patterns for home, admin, and app includes
  - [x] Create placeholder `urls.py` in each app
  - [x] Add health check endpoint at `/health/` returning JSON `{"status": "healthy", "database": "connected"}` with DB connection verification

- [x] Task 9: Setup CI/CD with GitHub Actions (AC: 5)
  - [x] Create `.github/workflows/ci.yml` with: checkout, Python 3.10 setup, uv install, ruff check, ruff format --check, Django checks, migrations, pytest with coverage
  - [x] Configure PostgreSQL 14 service container for CI tests
  - [x] Create `.github/workflows/deploy.yml` for PythonAnywhere deployment on push to main (pull code, install deps, migrate, collectstatic, reload app, verify)

- [x] Task 10: Create development setup script (AC: 1)
  - [x] Create `scripts/setup_dev.sh` that automates: Python version check, uv install, venv creation, dependency install, .env setup, DB validation, migrations, superuser creation, pre-commit hooks
  - [x] Make script executable

- [x] Task 11: Verify and validate (AC: 1, 2, 7)
  - [x] Run `python manage.py check` successfully
  - [x] Run `python manage.py migrate` successfully
  - [x] Run `python manage.py runserver` and verify home page loads
  - [x] Verify health check endpoint returns 200 with JSON response
  - [x] Run `ruff check .` with no errors
  - [x] Run `pytest` (empty test suite should pass)

## Dev Notes

### Project Structure

The project follows the monolithic Django architecture defined in the architecture docs. Key directories: [Source: architecture/source-tree.md#Project Root]

```
todo/
├── todo_project/          # Django project config
│   └── settings/          # Split settings (base, dev, prod, test)
├── apps/                  # Django applications
│   ├── accounts/          # User management
│   ├── tasks/             # Core task management
│   └── visualization/     # Network graph
├── static/                # Static assets (source)
├── templates/             # Global templates
├── requirements/          # Dependency management (uv)
├── scripts/               # Utility scripts
├── tests/                 # Project-wide integration tests
└── .github/workflows/     # CI/CD
```

### Tech Stack Details

- **Django 4.2 LTS** - Web framework [Source: architecture/tech-stack.md#Complete Stack Table]
- **PostgreSQL 14+** - Primary data store [Source: architecture/tech-stack.md#Complete Stack Table]
- **uv** - Package manager (10-100x faster than pip) [Source: architecture/tech-stack.md#Modern Python Tooling]
- **ruff** - Unified linting and formatting (replaces black, isort, flake8, pylint) [Source: architecture/tech-stack.md#Modern Python Tooling]
- **WhiteNoise 6.6+** - Static file serving [Source: architecture/tech-stack.md#Complete Stack Table]
- **Sentry** - Error tracking (production) [Source: architecture/tech-stack.md#Complete Stack Table]
- **Argon2** - Password hashing [Source: architecture/tech-stack.md#Complete Stack Table]

### Settings Configuration

Split settings pattern with environment-based overrides: [Source: architecture/source-tree.md#Settings Structure]

- **base.py**: Common settings (installed apps, middleware, DB from env, static files, templates)
- **development.py**: `DEBUG=True`, Django Debug Toolbar, verbose logging, local DB
- **production.py**: `DEBUG=False`, security headers, Sentry, WhiteNoise `CompressedManifestStaticFilesStorage`, production DB
- **test.py**: SQLite in-memory, faster password hashing

### Dependency Management

Requirements use `.in` source files compiled with `uv pip compile` to `.txt` lock files: [Source: architecture/tech-stack.md#Dependency Management Strategy]

```
requirements/
├── base.in → base.txt           # Core deps
├── production.in → production.txt  # Extends base
└── development.in → development.txt  # Extends production
```

Version pinning: compatible pins (`>=,<`) in `.in` files, exact pins in compiled `.txt` files. [Source: architecture/tech-stack.md#Version Pinning Strategy]

### Ruff Configuration

Must be configured in `pyproject.toml` with these rules: [Source: architecture/coding-standards.md#PEP 8 Compliance]

```toml
[tool.ruff]
line-length = 88
target-version = "py310"

[tool.ruff.lint]
select = ["E", "W", "F", "I", "DJ", "N", "UP", "C90"]
ignore = ["E501"]

[tool.ruff.lint.per-file-ignores]
"**/migrations/*.py" = ["E501", "DJ01"]
"**/tests/*.py" = ["S101"]
```

### CI/CD Pipeline

**CI workflow** (`.github/workflows/ci.yml`): Triggers on push to main/develop, PRs to main. Uses PostgreSQL 14 service container, uv for deps, runs ruff check + format check, Django checks, migrations, pytest with coverage. [Source: architecture/deployment-architecture.md#CI Workflow]

**CD workflow** (`.github/workflows/deploy.yml`): Triggers on push to main. SSHs to PythonAnywhere, pulls code, installs production deps via uv, runs migrations, collects static files, reloads web app via API, verifies deployment with HTTP check. [Source: architecture/deployment-architecture.md#CD Workflow]

### Health Check Endpoint

Must be at `/health/` and verify database connectivity: [Source: architecture/deployment-architecture.md#Health Check Endpoint]

```python
def health_check(request):
    try:
        with connection.cursor() as cursor:
            cursor.execute("SELECT 1")
        return JsonResponse({'status': 'healthy', 'database': 'connected'})
    except Exception as e:
        return JsonResponse({'status': 'unhealthy', 'error': str(e)}, status=500)
```

### Environment Variables

Required variables defined in `.env.example`: [Source: architecture/source-tree.md#.env.example]

- `SECRET_KEY`, `DEBUG`, `ALLOWED_HOSTS`
- `DATABASE_URL` (PostgreSQL connection string)
- `EMAIL_BACKEND`, `EMAIL_HOST`, `EMAIL_PORT`, `EMAIL_USE_TLS`, `EMAIL_HOST_USER`, `EMAIL_HOST_PASSWORD`
- `SENTRY_DSN`
- `PYTHONANYWHERE_USERNAME`, `PYTHONANYWHERE_API_TOKEN`

### Pre-commit Hooks

Use ruff pre-commit hooks: [Source: architecture/development-workflow.md#Pre-commit Hook Flow]

```yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.9
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format
```

### Naming Conventions

- Python modules: snake_case [Source: architecture/source-tree.md#File Naming Conventions]
- Python classes: PascalCase
- URL names: kebab-case (`task-list`, `task-create`)
- Templates: kebab-case
- Static files: kebab-case
- Import style: Absolute imports preferred (`from apps.tasks.models import Task`) [Source: architecture/source-tree.md#Import Path Conventions]

### Git Standards

- Commit format: `<type>: <subject>` (feat, fix, docs, style, refactor, test, chore) [Source: architecture/coding-standards.md#Git Commit Standards]
- Branch naming: `feature/short-description`, `bugfix/short-description` [Source: architecture/coding-standards.md#Branch Naming]

### Previous Story Insights

No previous stories exist - this is the first story in the project.

### Testing

**Test file location**: Tests live in `apps/{app_name}/tests/` and `tests/` (project-wide) [Source: architecture/testing-strategy.md#Test File Organization]

**Test standards**: [Source: architecture/testing-strategy.md#Testing Philosophy]
- Use pytest as the test framework with pytest-django
- Use Factory Boy for test data generation
- Minimum 80% code coverage target
- Descriptive test names: `test_task_is_overdue_when_due_date_past_and_not_done()`
- Use `@pytest.mark.django_db` for database tests

**Testing frameworks**: pytest 7.4+, pytest-cov 4.1+, Factory Boy 3.3+, Playwright 1.40+ (E2E) [Source: architecture/tech-stack.md#Complete Stack Table]

**Pytest config** in `pyproject.toml`: [Source: architecture/source-tree.md#pyproject.toml]
```toml
[tool.pytest.ini_options]
DJANGO_SETTINGS_MODULE = "todo_project.settings.test"
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = "--cov=apps --cov-report=html --cov-report=term"
testpaths = ["apps", "tests"]
```

**For this story**: No unit tests for business logic yet (no models/views to test). The story validates through successful `python manage.py check`, working runserver, health check endpoint returning 200, and ruff passing cleanly.

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `manage.py` | Created | Django management script (points to development settings) |
| `todo_project/__init__.py` | Created | Django project package init |
| `todo_project/settings/__init__.py` | Created | Split settings package init |
| `todo_project/settings/base.py` | Created | Base settings (common across environments) |
| `todo_project/settings/development.py` | Created | Development settings (DEBUG, Debug Toolbar) |
| `todo_project/settings/production.py` | Created | Production settings (security, Sentry, WhiteNoise) |
| `todo_project/settings/test.py` | Created | Test settings (SQLite in-memory, fast hashing) |
| `todo_project/urls.py` | Modified | Root URL config with home, health check, app includes |
| `todo_project/wsgi.py` | Modified | Points to production settings |
| `todo_project/asgi.py` | Modified | Points to production settings |
| `apps/__init__.py` | Created | Apps package init |
| `apps/accounts/` | Created | Accounts app scaffolding (apps.py, admin.py, models.py, views.py, urls.py, etc.) |
| `apps/tasks/` | Created | Tasks app scaffolding |
| `apps/visualization/` | Created | Visualization app scaffolding |
| `requirements/base.in` | Created | Core dependency source file |
| `requirements/base.txt` | Created | Compiled core dependencies |
| `requirements/production.in` | Created | Production dependency source file |
| `requirements/production.txt` | Created | Compiled production dependencies |
| `requirements/development.in` | Created | Development dependency source file |
| `requirements/development.txt` | Created | Compiled development dependencies |
| `.env.example` | Created | Environment variable template |
| `.env` | Created | Local environment config (gitignored) |
| `pyproject.toml` | Created | Project config (ruff, pytest) |
| `.pre-commit-config.yaml` | Created | Pre-commit hooks config (ruff) |
| `templates/base.html` | Created | Base HTML template (Bootstrap 5.3) |
| `templates/home.html` | Created | Home page template |
| `templates/404.html` | Created | 404 error page |
| `templates/500.html` | Created | 500 error page |
| `templates/includes/navbar.html` | Created | Navigation bar partial |
| `templates/includes/footer.html` | Created | Footer partial |
| `static/css/base.css` | Created | Global CSS with CSS variables |
| `static/js/base.js` | Created | Global JS (CSRF cookie helper) |
| `.github/workflows/ci.yml` | Created | CI pipeline (ruff, tests, Django checks) |
| `.github/workflows/deploy.yml` | Created | CD pipeline (PythonAnywhere deploy) |
| `scripts/setup_dev.sh` | Created | Development setup automation script |
| `tests/__init__.py` | Created | Project-wide tests package init |
| `tests/conftest.py` | Created | Pytest global fixtures (empty) |
| `.gitignore` | Modified | Removed `static/` from ignore (source files should be tracked) |

### Debug Log References
No debug issues encountered.

### Completion Notes
- PostgreSQL not installed locally; using SQLite for local development and tests. Production uses PostgreSQL via `DATABASE_URL` with `dj-database-url`.
- Added `dj-database-url` and `python-dotenv` to `base.in` dependencies (not in original story spec but required for DATABASE_URL parsing and .env loading).
- All 11 tasks completed. All validations pass: Django check, migrations, runserver, health check (200), ruff check, ruff format, pytest infrastructure.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story draft | SM Agent (Bob) |
| 2026-02-05 | 0.2 | Implementation complete - all tasks done | Dev Agent (James) |
