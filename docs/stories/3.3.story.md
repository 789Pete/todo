# Story 3.3: Interactive Network Graph Display

<!-- Source: Sharded PRD (docs/prd/epic-3-network-graph-visualization.md) + Architecture docs -->
<!-- Context: Brownfield enhancement to existing vis-network graph (Stories 3.1 + 3.2 complete) -->

## Status: Ready for Review

## Story

**As a** user,
**I want** to see my tasks and tags as an interactive network graph with rich visual indicators,
**so that** I can visually understand relationships and patterns in my work at a glance.

## Context Source

- Source Document: `docs/prd/epic-3-network-graph-visualization.md` + `docs/architecture/api-specification.md`
- Enhancement Type: Visual enrichment of existing graph (no new API endpoints, no new models)
- Existing System Impact: Modifies `graph_builder.py` (node/edge properties), `graph-viewer.js` (clustering), `graph.html` (legend)
- Depends On: Story 3.1 (vis-network integrated) and Story 3.2 (real API data, `/api/graph/data/` live)

## Acceptance Criteria

1. Tasks displayed as nodes with visual indicators for priority, completion status, and due dates
2. Tags displayed as nodes with color coding and size indicating usage frequency
3. Edges connecting tasks to their associated tags with relationship strength visualization
4. Zoom and pan functionality for exploring large networks
5. Node clustering or grouping when graph becomes dense (50+ nodes)
6. Layout algorithm automatically positions nodes for optimal relationship visibility
7. Graph legend explaining node types, colors, and relationship indicators

## Dev Notes

### Previous Story Insights (from 3.1 + 3.2)

- **vis-network 9.x** is vendored at `static/js/vendor/vis-network.min.js`
- `graph-viewer.js` already fetches from `/api/graph/data/`, shows loading spinner, handles errors
- `apps/visualization/graph_builder.py` builds nodes/edges; `build_graph_data(user, filter_tag, filter_status)` is the main function
- `getCookie` is globally available from `static/js/base.js` — no need to redefine
- Physics + zoom/pan/drag + `improvedLayout: true` are already configured in `graph-viewer.js` — ACs 4 and 6 are already met by vis-network defaults; do not remove or refactor these options
- 318 tests currently passing (baseline)
- No new Python packages required; no new Django apps, models, or migrations needed

### AC Scope Notes

- **AC4 (zoom/pan)**: Already implemented in Story 3.1 via vis-network `zoomView: true, dragView: true` options. ✅ Nothing to change.
- **AC6 (layout algorithm)**: Already implemented via `physics: {enabled: true, stabilization: {...}}` and `layout: {improvedLayout: true}`. ✅ Nothing to change.
- **AC1, AC2, AC3**: Require changes to `graph_builder.py` to enrich node/edge data.
- **AC5**: Requires changes to `graph-viewer.js` to trigger clustering after network init.
- **AC7**: Requires adding a legend overlay to `apps/visualization/templates/visualization/graph.html`.

### Current File State

**`apps/visualization/graph_builder.py`** (simplified current structure):

```python
TASK_STATUS_COLORS = {
    "todo": {"background": "#e3f2fd", "border": "#2196f3"},
    "in_progress": {"background": "#fff8e1", "border": "#ff9800"},
    "done": {"background": "#e8f5e9", "border": "#4caf50"},
}

def build_graph_data(user, filter_tag=None, filter_status=None):
    # ... builds task nodes with status color only
    # ... builds tag nodes with tag color only
    # ... builds edges with uniform color="#999999", width=1
    # returns {nodes, edges, stats}

def _darken_hex(hex_color): ...
```

**`apps/visualization/templates/visualization/graph.html`** (current):
```html
{% block content %}
<h1 class="h3 mb-3">Task Network Graph</h1>
<div id="network-graph" class="graph-container"></div>
<noscript>...</noscript>
{% endblock %}
```

### Changes Required

#### 1. `apps/visualization/graph_builder.py` — Enhanced Node & Edge Properties

Add these constants after the existing `TASK_STATUS_COLORS`:

```python
from django.utils import timezone

PRIORITY_BORDER_WIDTH = {
    "high": 3,
    "medium": 2,
    "low": 1,
}

PRIORITY_EDGE_WIDTH = {
    "high": 3,
    "medium": 2,
    "low": 1,
}

PRIORITY_EDGE_COLOR = {
    "high": "#ff9800",
    "medium": "#999999",
    "low": "#cccccc",
}

BASE_TAG_SIZE = 15        # minimum ellipse size (pixels)
TAG_SIZE_PER_TASK = 3     # extra pixels per task using this tag
MAX_TAG_SIZE = 50         # cap so large tags don't dominate
```

**Task node changes** — add `borderWidth` and `font` (for overdue highlight). Inside the `for task in tasks:` loop:

```python
is_overdue = (
    task.due_date
    and task.due_date < timezone.now().date()
    and task.status != "done"
)
font_cfg = {"color": "#cc0000"} if is_overdue else {"color": "#333333"}

tooltip_parts = [f"Priority: {task.priority}"]
if task.due_date:
    label = f"Due: {task.due_date}"
    if is_overdue:
        label += " ⚠ OVERDUE"
    tooltip_parts.append(label)
tag_names = [t.name for t in task.tags.all()]
if tag_names:
    tooltip_parts.append(f"Tags: {', '.join(tag_names)}")

task_nodes.append({
    "id": task_id,
    "label": task.title,
    "group": task.status,
    "shape": "box",
    "color": status_color,
    "title": "\n".join(tooltip_parts),
    "borderWidth": PRIORITY_BORDER_WIDTH.get(task.priority, 2),
    "font": font_cfg,
})
```

**Edge changes** — use priority-based width and color. Inside `for tag in task.tags.all():`:

```python
edges.append({
    "from": task_id,
    "to": tag_id,
    "width": PRIORITY_EDGE_WIDTH.get(task.priority, 1),
    "color": PRIORITY_EDGE_COLOR.get(task.priority, "#999999"),
})
```

**Tag node changes** — add `size` based on usage. Inside the tag nodes loop:

```python
tag_nodes.append({
    "id": f"tag-{tag.id}",
    "label": tag.name,
    "group": "tag",
    "shape": "ellipse",
    "color": {
        "background": tag.color,
        "border": _darken_hex(tag.color),
    },
    "title": f"{task_count} task{'s' if task_count != 1 else ''}",
    "size": min(BASE_TAG_SIZE + task_count * TAG_SIZE_PER_TASK, MAX_TAG_SIZE),
})
```

**Note on `timezone` import**: Add `from django.utils import timezone` at the top of `graph_builder.py` with the other imports.

#### 2. `static/js/graph-viewer.js` — Node Clustering for 50+ Nodes

After the `network` object is created (after `const network = new vis.Network(container, data, options);`), add the clustering block:

```javascript
// AC5: Cluster task nodes by status when graph is dense (50+ nodes)
var nodeCount = graphData.nodes.length;
if (nodeCount > 50) {
    var groupConfig = {
        todo:        {label: 'To Do tasks',       color: {background: '#e3f2fd', border: '#2196f3'}},
        in_progress: {label: 'In Progress tasks',  color: {background: '#fff8e1', border: '#ff9800'}},
        done:        {label: 'Done tasks',         color: {background: '#e8f5e9', border: '#4caf50'}},
    };
    Object.keys(groupConfig).forEach(function (group) {
        var cfg = groupConfig[group];
        network.cluster({
            joinCondition: function (nodeOptions) {
                return nodeOptions.group === group;
            },
            clusterNodeProperties: {
                id: 'cluster-' + group,
                label: cfg.label,
                shape: 'box',
                color: cfg.color,
                borderWidth: 2,
                font: {size: 14},
            },
        });
    });
}
```

Place this block **before** the `window.addEventListener('resize', ...)` line, and **before** `window.testGraphPerformance`.

#### 3. `apps/visualization/templates/visualization/graph.html` — Graph Legend (AC7)

Add the legend HTML **inside `{% block content %}`**, after the `<div id="network-graph" ...>` div:

```html
{# AC7: Graph legend — positioned over the bottom-left corner of the graph #}
<div class="graph-legend" id="graph-legend" aria-label="Graph legend">
    <strong class="d-block mb-2">Legend</strong>
    <div class="legend-section">
        <small class="text-muted d-block mb-1">Task Status</small>
        <div class="legend-item">
            <span class="legend-node legend-box" style="background:#e3f2fd;border-color:#2196f3;"></span>
            To Do
        </div>
        <div class="legend-item">
            <span class="legend-node legend-box" style="background:#fff8e1;border-color:#ff9800;"></span>
            In Progress
        </div>
        <div class="legend-item">
            <span class="legend-node legend-box" style="background:#e8f5e9;border-color:#4caf50;"></span>
            Done
        </div>
    </div>
    <div class="legend-section mt-2">
        <small class="text-muted d-block mb-1">Priority (border width)</small>
        <div class="legend-item">
            <span class="legend-node legend-box" style="background:#f5f5f5;border-color:#888;border-width:3px;"></span>
            High
        </div>
        <div class="legend-item">
            <span class="legend-node legend-box" style="background:#f5f5f5;border-color:#888;border-width:2px;"></span>
            Medium
        </div>
        <div class="legend-item">
            <span class="legend-node legend-box" style="background:#f5f5f5;border-color:#888;border-width:1px;"></span>
            Low
        </div>
    </div>
    <div class="legend-section mt-2">
        <small class="text-muted d-block mb-1">Other</small>
        <div class="legend-item">
            <span class="legend-node legend-ellipse"></span>
            Tag (size = usage)
        </div>
        <div class="legend-item">
            <span class="legend-text-red">Red label</span>
            Overdue task
        </div>
    </div>
</div>
```

#### 4. `static/css/graph.css` — Legend Styles

`.graph-container` already has `position: relative` in `graph.css` (confirmed) — no change needed for that rule. Append only the legend styles below:

```css
/* Graph legend overlay */
.graph-legend {
    position: absolute;
    bottom: 16px;
    left: 16px;
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 10px 14px;
    font-size: 0.78rem;
    z-index: 10;
    pointer-events: none;
    max-width: 160px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
}

.legend-node {
    display: inline-block;
    flex-shrink: 0;
}

.legend-box {
    width: 18px;
    height: 14px;
    border: 2px solid;
    border-radius: 2px;
}

.legend-ellipse {
    width: 18px;
    height: 12px;
    background: #4ecdc4;
    border: 1px solid #3aa89e;
    border-radius: 50%;
}

.legend-text-red {
    color: #cc0000;
    font-weight: 500;
}
```

**Note**: `.graph-container` already has `position: relative` in `graph.css` — the legend's `position: absolute` will work without any change to the existing rule.

[Source: architecture/source-tree.md#static-files-organization]

### Testing

[Source: architecture/testing-strategy.md#unit-testing]

- **Framework**: pytest + `@pytest.mark.django_db`
- **Test file to modify**: `apps/visualization/tests/test_graph_builder.py` (already exists from Story 3.2)
- **Factories**: `UserFactory`, `TaskFactory`, `TagFactory` from `apps/tasks/tests/factories` and `apps/accounts/tests/factories`
- **Required new import** in test file: `from datetime import date, timedelta` (for overdue date construction)
- **Existing test to update**: `test_edge_structure` — change `assert edge["width"] == 1` to `assert edge["width"] == 2` (medium priority default)
- **Pattern for overdue tests**: `TaskFactory(user=user, due_date=date.today() - timedelta(days=1), status="todo")`
- **Pattern for tag size tests**: create multiple tasks tagged with same tag, then check `tag_node["size"]` in the result
- **No JS unit tests** required for the clustering feature — manual verification via `testGraphPerformance()` in browser console is the specified approach
- **Coverage target**: 90%+ on `graph_builder.py` (API/business logic)
- **Run**: `.venv/bin/pytest apps/visualization/tests/test_graph_builder.py -v`

### File Locations

[Source: architecture/source-tree.md#application-structure]

```
apps/visualization/
├── graph_builder.py          ← MODIFY (enhance node/edge properties)
├── templates/
│   └── visualization/
│       └── graph.html        ← MODIFY (add legend)
└── tests/
    └── test_graph_builder.py ← MODIFY (add new test cases)

static/
├── css/
│   └── graph.css             ← MODIFY (add legend styles)
└── js/
    └── graph-viewer.js       ← MODIFY (add clustering for 50+ nodes)
```

### Data Model Reference

[Source: architecture/data-models.md#task-model]

Task fields used:
- `task.priority` → `"low" | "medium" | "high"` (for border width and edge color)
- `task.due_date` → `DateField` (null=True) — compare against `timezone.now().date()`
- `task.status` → `"todo" | "in_progress" | "done"` (for overdue check: done tasks are never overdue)

Tag fields used:
- `tag.color` → hex string (already used for background)
- `tag.tasks.filter(user=user).count()` → task_count for size calculation

### Technical Constraints

[Source: architecture/tech-stack.md#frontend-framework]

- **No new Python packages** — all changes use existing Django + built-in Python
- **No new migrations** — no model changes
- **vis-network 9.x** — `network.cluster({joinCondition, clusterNodeProperties})` is the correct API for grouping nodes. `clusterByGroup` is NOT a vis-network 9.x method — use `cluster()` with `joinCondition` instead.
- `from django.utils import timezone` must be imported in `graph_builder.py` for `timezone.now().date()`
- Tag `size` property only applies to non-box shapes. Since tag nodes use `shape: "ellipse"`, `size` scales the node correctly.
- Legend uses `position: absolute` — `.graph-container` in `graph.css` already has `position: relative`, so no change is needed there.

## Tasks / Subtasks

- [x] **Task 1**: Enhance `apps/visualization/graph_builder.py` (AC: 1, 2, 3)
  - [x] Add `from django.utils import timezone` import
  - [x] Add `PRIORITY_BORDER_WIDTH`, `PRIORITY_EDGE_WIDTH`, `PRIORITY_EDGE_COLOR`, `BASE_TAG_SIZE`, `TAG_SIZE_PER_TASK`, `MAX_TAG_SIZE` constants
  - [x] Add `is_overdue` calculation per task inside the task loop
  - [x] Add `borderWidth` and `font` (color) to task node dicts based on priority and overdue status
  - [x] Add overdue indicator to task tooltip ("⚠ OVERDUE" suffix on due date line)
  - [x] Update edges to use `PRIORITY_EDGE_WIDTH` and `PRIORITY_EDGE_COLOR` based on `task.priority`
  - [x] Add `size` property to tag node dicts: `min(BASE_TAG_SIZE + task_count * TAG_SIZE_PER_TASK, MAX_TAG_SIZE)`

- [x] **Task 2**: Update and extend `apps/visualization/tests/test_graph_builder.py` (AC: 1, 2, 3)
  - [x] Add `from datetime import date, timedelta` to the import block at the top of the file (needed for overdue tests)
  - [x] **UPDATE existing test** `test_edge_structure`: updated `width` assertion from 1 → 2 (medium priority)
  - [x] Add `test_high_priority_task_has_thick_border`
  - [x] Add `test_medium_priority_task_has_medium_border`
  - [x] Add `test_low_priority_task_has_thin_border`
  - [x] Add `test_overdue_task_has_red_font`
  - [x] Add `test_done_task_not_marked_overdue`
  - [x] Add `test_future_due_date_not_overdue`
  - [x] Add `test_no_due_date_not_overdue`
  - [x] Add `test_overdue_tooltip_contains_warning`
  - [x] Add `test_tag_size_scales_with_task_count`
  - [x] Add `test_tag_size_base_for_single_task`
  - [x] Add `test_tag_size_capped_at_maximum`
  - [x] Add `test_high_priority_edge_is_wide`
  - [x] Add `test_high_priority_edge_color`
  - [x] Add `test_low_priority_edge_color`

- [x] **Task 3**: Update `static/js/graph-viewer.js` — node clustering for 50+ nodes (AC: 5)
  - [x] After `const network = new vis.Network(...)`, add clustering block
  - [x] Check `graphData.nodes.length > 50`; if so, call `network.cluster(...)` for each of the 3 status groups
  - [x] Each cluster node uses status-matching label and color from `groupConfig`
  - [x] Clustering block comes BEFORE the resize listener and `testGraphPerformance` helper

- [x] **Task 4**: Add graph legend to `apps/visualization/templates/visualization/graph.html` (AC: 7)
  - [x] Add legend `<div class="graph-legend" ...>` inside `{% block content %}`, after `#network-graph`
  - [x] Legend sections: Task Status colors, Priority border widths, Tag ellipse with size note, Red text = overdue

- [x] **Task 5**: Add legend CSS to `static/css/graph.css` (AC: 7)
  - [x] `.graph-container` already has `position: relative` — not touched
  - [x] Appended `.graph-legend`, `.legend-item`, `.legend-node`, `.legend-box`, `.legend-ellipse`, `.legend-text-red` styles

- [x] **Task 6**: Validate and verify (AC: 1–7)
  - [x] Run `ruff check .` — no errors
  - [x] Run `ruff format --check .` — no errors
  - [x] Run `pytest` — 332 passed (318 baseline + 14 new)
  - [x] Run `python manage.py check` — no issues
  - [x] Run `python manage.py makemigrations --check` — no new migrations
  - [ ] Manual: Load `/visualization/` — legend visible bottom-left of graph canvas
  - [ ] Manual: Create tasks with different priorities — verify border widths differ
  - [ ] Manual: Make a task overdue — verify red label in graph
  - [ ] Manual (or console): Call `testGraphPerformance()` — verify clustering triggers at 50+ nodes

## Risk Assessment

### Implementation Risks

- **Risk**: `network.cluster()` API may behave unexpectedly if called before stabilization — **Mitigation**: Call clustering after `new vis.Network()` but the network starts rendering immediately; clustering before `stabilized` event is safe for initial load
- **Risk**: Adding `size` to tag nodes may conflict with existing sizing — **Mitigation**: `size` only affects non-box shapes; ellipse uses it correctly; box shape ignores it
- **Risk**: Overdue calculation requires `timezone.now().date()` — if test DB uses naive datetimes, may need `@override_settings` or freeze_time — **Mitigation**: Use a past `due_date` (e.g., `date.today() - timedelta(days=1)`) in tests; `timezone.now().date()` is always "today"

### Safety Checks

- [ ] All existing 318 tests pass before making changes (verify baseline)
- [ ] `.graph-container` confirmed to have `position: relative` already — legend positioning will work
- [ ] Clustering block does not throw errors when node count ≤ 50 (the `if nodeCount > 50` guard handles this)

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-6

### Completion Notes List

- 332 tests pass (318 baseline + 14 new). 1 existing test (`test_edge_structure`) updated: `width` assertion changed from 1 → 2 to reflect medium priority edge width.
- `graph_builder.py` achieves 100% test coverage.
- `timezone.now().date()` used for overdue calculation — reliable in tests using `date.today() ± timedelta`.
- Tag node `size` property only works for non-box shapes; ellipse uses it correctly. Box-shaped task nodes are unaffected.
- vis-network `network.cluster()` API used (not `clusterByGroup`, which does not exist in v9.x).
- Manual browser verification (legend, priority borders, overdue red, clustering at 50+ nodes) left to human reviewer.
- AC4 (zoom/pan) and AC6 (layout) were already fully implemented in Stories 3.1/3.2 — no changes made.

### Debug Log References

### File List

**Modified:**
- `apps/visualization/graph_builder.py`
- `apps/visualization/tests/test_graph_builder.py`
- `static/js/graph-viewer.js`
- `apps/visualization/templates/visualization/graph.html`
- `static/css/graph.css`

**No new files. No migrations.**

**No new files needed. No migrations needed.**

## QA Results

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 0.1 | Initial story draft | SM Agent (Bob) |
| 2026-02-20 | 0.2 | Fix breaking test issue, import hint, position:relative clarification, Testing section | SM Agent (Bob) |
| 2026-02-20 | 1.0 | Implementation complete | Dev Agent (James) |
