# Story 2.1: Tag Model and Database Design

## Status

Ready for Review

## Story

**As a** developer,
**I want** properly designed tag models with efficient many-to-many relationships,
**so that** the application can handle complex tag queries and relationships performantly.

## Acceptance Criteria

1. Tag model includes name, color, user, created_at fields with unique constraints
2. Many-to-many relationship between Tasks and Tags with through table optimization
3. Database indexes on tag name and user for fast filtering queries
4. Tag color field supports hex color codes with validation
5. Cascade deletion rules ensure orphaned tags are handled appropriately
6. Tag model includes usage count calculation for relationship strength metrics
7. Database migration preserves existing task data while adding tag functionality

## Tasks / Subtasks

- [x] Task 1: Verify and enhance Tag model completeness (AC: 1, 3, 4)
  - [x] Verify existing Tag model fields match architecture spec: `id` (UUID), `user` (FK), `name` (CharField max 50), `color` (CharField max 7), `created_at` (auto_now_add)
  - [x] Verify `unique_together = [["user", "name"]]` constraint exists
  - [x] Verify `indexes = [models.Index(fields=["user", "name"])]` exists
  - [x] Add a `clean()` method to enforce case-insensitive tag name uniqueness (prevent "Work" and "work" as separate tags for same user)
  - [x] Add hex color code validation in `clean()` — validate that `color` is a valid 7-character hex code (e.g., `#FF6B6B`) using regex, even though predefined `COLOR_CHOICES` exist
- [x] Task 2: Verify ManyToMany relationship and through table (AC: 2)
  - [x] Verify existing `tags = models.ManyToManyField("Tag", related_name="tasks", blank=True)` on Task model
  - [x] Verify Django's auto-generated through table (`task_tags`) has proper indexes on `task_id` and `tag_id` (Django does this by default — confirm via migration inspection)
  - [x] Add a test confirming the through table functions correctly (add/remove tags, query from both sides)
- [x] Task 3: Verify and test cascade deletion rules (AC: 5)
  - [x] Verify `on_delete=models.CASCADE` on Tag.user FK — deleting user deletes their tags
  - [x] Verify that deleting a Tag removes it from all associated tasks' M2M but does NOT delete the tasks
  - [x] Verify that deleting a Task removes M2M entries but does NOT delete associated tags
  - [x] Add tests for all three cascade scenarios
- [x] Task 4: Add usage count and relationship strength methods (AC: 6)
  - [x] Add `task_count` property to Tag model that returns `self.tasks.count()` [Source: architecture/data-models.md#Tag Model Methods]
  - [x] Add `get_related_tags()` method to Tag model that finds tags frequently co-occurring on the same tasks, ordered by shared count [Source: architecture/data-models.md#Tag Model Methods]
  - [x] Add `get_related_tasks()` method to Task model that finds tasks sharing tags with the current task [Source: architecture/data-models.md#Task Model Methods]
  - [x] Write tests for `task_count`, `get_related_tags()`, and `get_related_tasks()`
- [x] Task 5: Verify migration safety (AC: 7)
  - [x] Confirm existing migrations (`0001_initial.py`, `0002_task_completed_at.py`) already include the Tag model and M2M relationship
  - [x] Run `python manage.py makemigrations --check` to ensure no new migrations are needed (unless clean() or model changes require one)
  - [x] If model changes are made, create migration and verify it applies cleanly on top of existing data
  - [x] Run `python manage.py migrate` to confirm all migrations apply without errors
- [x] Task 6: Enhance admin configuration (AC: 1, 6)
  - [x] Add `task_count` display to `TagAdmin.list_display` using annotated queryset for efficiency
  - [x] Override `get_queryset` in TagAdmin to annotate with `Count('tasks')` to avoid N+1 queries
- [x] Task 7: Write comprehensive Tag model tests (AC: 1-6)
  - [x] Test case-insensitive uniqueness validation (clean method rejects "work" when "Work" exists for same user)
  - [x] Test hex color validation rejects invalid values (e.g., "red", "#GGG", "12345")
  - [x] Test `task_count` property returns correct count (0, 1, many)
  - [x] Test `get_related_tags()` returns tags that co-occur on tasks, ordered by frequency
  - [x] Test `get_related_tags()` excludes self from results
  - [x] Test `get_related_tags()` returns empty for tags with no shared tasks
  - [x] Test `get_related_tasks()` returns tasks sharing tags, excludes self
  - [x] Test cascade: deleting a tag does not delete associated tasks
  - [x] Test cascade: deleting a task does not delete associated tags
  - [x] Test that M2M through table entries are cleaned up on tag/task deletion
- [x] Task 8: Validate and verify (AC: 1-7)
  - [x] Run `ruff check .` with no errors
  - [x] Run `ruff format --check .` with no errors
  - [x] Run `pytest` with all tests passing
  - [x] Run `python manage.py check` with no issues
  - [x] Run `python manage.py makemigrations --check` to confirm no pending migrations

## Dev Notes

### Previous Story Insights

From Story 1.6 (Responsive UI Framework) Dev Agent Record:
- All 116 existing tests pass with 99% coverage — no regressions from responsive changes
- Template changes were CSS/HTML-only, no backend modifications
- No debug issues encountered

From Story 1.3 (Basic Task Model and Database Design):
- Tag model and ManyToMany relationship were already created as part of Story 1.3
- TagFactory, TagAdmin, and basic Tag model tests already exist
- This means Story 2.1 is primarily about **enhancing and verifying** the existing Tag infrastructure, not creating it from scratch

### CRITICAL: What Already Exists

The Tag model and Task-Tag relationship were implemented in Story 1.3. The dev agent MUST review the existing code before making changes. Here is what already exists:

**Tag model** (`apps/tasks/models.py`):
- Fields: `id` (UUID PK), `user` (FK to User, CASCADE), `name` (CharField max 50), `color` (CharField max 7, with COLOR_CHOICES), `created_at` (auto_now_add)
- `COLOR_CHOICES`: 8 predefined hex colors (Red, Teal, Blue, Orange, Mint, Yellow, Purple, Sky Blue)
- `Meta`: `db_table = "tags"`, `ordering = ["name"]`, `unique_together = [["user", "name"]]`, index on `["user", "name"]`
- `__str__`: returns `f"{self.name} ({self.color})"`

**Task model M2M** (`apps/tasks/models.py`):
- `tags = models.ManyToManyField("Tag", related_name="tasks", blank=True)`
- Through table auto-generated by Django as `task_tags`

**TagAdmin** (`apps/tasks/admin.py`):
- `list_display = ("name", "user", "color", "created_at")`
- `list_filter = ("color", "user")`
- `search_fields = ("name",)`

**TagFactory** (`apps/tasks/tests/factories.py`):
- Generates sequential names `Tag0`, `Tag1`, etc.
- Default color `#4ECDC4`
- Uses `UserFactory` SubFactory

**Existing Tag tests** (`apps/tasks/tests/test_models.py`):
- `test_tag_creation`, `test_tag_has_uuid_primary_key`, `test_tag_str_representation`
- `test_tag_name_unique_per_user` (IntegrityError level)
- `test_tag_name_can_duplicate_across_users`
- `test_cascade_delete_user_deletes_tags`
- `test_tag_table_name`, `test_default_color`
- Task-Tag M2M tests on TestTaskModel: `test_task_tag_many_to_many`, `test_tag_references_tasks`

### What Needs to Be Added

Based on architecture docs and ACs, the following are NOT yet implemented:

1. **`clean()` method on Tag model** — for case-insensitive uniqueness and hex color validation
   [Source: architecture/data-models.md#Tag Validation]

2. **`task_count` property on Tag model** — `self.tasks.count()`
   [Source: architecture/data-models.md#Tag Model Methods]

3. **`get_related_tags()` method on Tag model** — finds tags that co-occur on tasks
   [Source: architecture/data-models.md#Tag Model Methods]
   ```python
   def get_related_tags(self):
       from django.db.models import Count
       return Tag.objects.filter(
           tasks__tags=self
       ).exclude(id=self.id).annotate(
           shared_count=Count('tasks')
       ).order_by('-shared_count')[:5]
   ```

4. **`get_related_tasks()` method on Task model** — finds tasks sharing tags
   [Source: architecture/data-models.md#Task Model Methods]
   ```python
   def get_related_tasks(self):
       return Task.objects.filter(
           user=self.user,
           tags__in=self.tags.all()
       ).exclude(id=self.id).distinct()
   ```

### Data Models

[Source: architecture/data-models.md#Tag Model]

Tag model specification:
| Field | Type | Constraints | Purpose |
|-------|------|-------------|---------|
| id | UUID | PK | Unique identifier |
| user | ForeignKey | FK to User, CASCADE | Tag owner |
| name | String(50) | Required | Tag label |
| color | String(7) | Choices, hex code | Display color |
| created_at | DateTime | Auto-set | Creation timestamp |

Business Rules:
- Tag names are unique per user (case-insensitive enforced in forms/clean)
- Tag names cannot be empty or whitespace-only
- Maximum 50 characters for tag name
- Color must be a valid hex code from predefined choices
- Deleting a tag removes it from all associated tasks (ManyToMany cascade)

[Source: architecture/data-models.md#Task-Tag Relationship]

Through table structure (auto-generated by Django):
- `task_id` UUID FK to tasks, CASCADE
- `tag_id` UUID FK to tags, CASCADE
- UNIQUE(task_id, tag_id)
- Indexes on task_id and tag_id

### Query Patterns

[Source: architecture/data-models.md#Query Patterns]

```python
# Get tag usage statistics (annotation-based, efficient)
from django.db.models import Count
tag_stats = Tag.objects.filter(user=request.user).annotate(
    task_count=Count('tasks')
).order_by('-task_count')

# Prefetch tags to avoid N+1
tasks = Task.objects.filter(user=request.user).prefetch_related('tags')
```

### File Locations

[Source: architecture/source-tree.md]

Files to modify:
- `apps/tasks/models.py` — Add `clean()`, `task_count`, `get_related_tags()` to Tag; add `get_related_tasks()` to Task
- `apps/tasks/admin.py` — Enhance TagAdmin with task_count annotation
- `apps/tasks/tests/test_models.py` — Add new tests for all enhancements
- `apps/tasks/tests/factories.py` — No changes needed (TagFactory already exists)

No new files needed.

### Technical Constraints

[Source: architecture/tech-stack.md]
- Django 4.2 LTS, Python 3.10+
- SQLite for local dev, PostgreSQL in production
- Use Django ORM for all queries (no raw SQL)

[Source: architecture/coding-standards.md]
- Use `@property` for computed fields like `task_count`
- Use `select_related`/`prefetch_related` to avoid N+1 queries
- Model methods for business logic
- UUID primary keys on all models
- BEM naming for CSS, snake_case for Python

### Testing

[Source: architecture/testing-strategy.md]

**Test file location**: `apps/tasks/tests/test_models.py` (add to existing `TestTagModel` class)

**Test standards**:
- Use pytest with `@pytest.mark.django_db`
- Use Factory Boy factories (`TagFactory`, `TaskFactory`, `UserFactory`)
- Descriptive test names: `test_<what>_<expected_behavior>`
- Test edge cases: empty results, boundary conditions
- Coverage target: 95%+ for models

**Test frameworks**: pytest, pytest-django, Factory Boy

**Run tests**: `.venv/bin/pytest`
**Run linting**: `.venv/bin/ruff check . && .venv/bin/ruff format --check .`

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6 (claude-opus-4-6)

### Completion Notes

- Tag model already existed from Story 1.3 — this story enhanced it with validation and relationship methods
- Added `clean()` method with case-insensitive uniqueness check and hex color regex validation
- Added `task_count` property, `get_related_tags()` method to Tag model
- Added `get_related_tasks()` method to Task model
- Enhanced TagAdmin with annotated `num_tasks` count (renamed from `task_count` to avoid property clash)
- No new migrations needed — all changes are methods/properties (no schema changes)
- 143 total tests pass (27 new tests added), 99% coverage
- No regressions from existing 116 tests

### Debug Log References

No debug issues encountered.

### File List

| File | Action | Description |
|------|--------|-------------|
| `apps/tasks/models.py` | Modified | Added `import re`, `ValidationError` import, `clean()` method with case-insensitive uniqueness + hex validation, `task_count` property, `get_related_tags()` to Tag; `get_related_tasks()` to Task |
| `apps/tasks/admin.py` | Modified | Added `Count` import, `get_queryset` with `num_tasks` annotation, `tag_task_count` display method to TagAdmin |
| `apps/tasks/tests/test_models.py` | Modified | Added 27 new tests: case-insensitive validation, hex color validation, task_count, get_related_tags, get_related_tasks, cascade deletion, M2M through table |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-16 | 0.1 | Initial story draft | SM Agent (Bob) |
| 2026-02-16 | 1.0 | Implementation complete — Tag model enhancements, relationship methods, comprehensive tests | Dev Agent (James) |
