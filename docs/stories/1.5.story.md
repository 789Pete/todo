# Story 1.5: Basic Priority and Status Management

## Status

Done

## Story

**As a** user,
**I want** to set task priorities and mark tasks as complete,
**so that** I can focus on important work and track my progress.

## Acceptance Criteria

1. Priority field supports High, Medium, Low values with color coding
2. Checkbox or button interface for marking tasks complete/incomplete
3. Completed tasks visually distinguished (strikethrough, grayed out, or separate section)
4. Task list can be filtered by completion status (all, active, completed)
5. High-priority tasks prominently displayed at top of list
6. Overdue tasks (past due date) highlighted with warning indicators
7. Task completion updates timestamps for tracking when work was finished

## Tasks / Subtasks

- [x] Task 1: Add `completed_at` field to Task model (AC: 7)
  - [x] Add `completed_at = models.DateTimeField(null=True, blank=True)` to `Task` model in `apps/tasks/models.py`
  - [x] Add `mark_complete()` method to Task model that sets `status = 'done'` and `completed_at = timezone.now()`
  - [x] Add `mark_incomplete()` method to Task model that sets `status = 'todo'` and `completed_at = None`
  - [x] Run `python manage.py makemigrations tasks` and `python manage.py migrate`
- [x] Task 2: Create toggle-status view in `apps/tasks/views.py` (AC: 2, 7)
  - [x] Create `TaskToggleStatusView` — a POST-only view that toggles a task between done and its previous non-done state (todo)
  - [x] Use `LoginRequiredMixin` and filter `get_queryset()` by `user=self.request.user` for security
  - [x] If task is currently not done → call `task.mark_complete()`, add success message `'Task "{task.title}" marked as complete!'`
  - [x] If task is currently done → call `task.mark_incomplete()`, add success message `'Task "{task.title}" marked as incomplete.'`
  - [x] Redirect back to `task-list` (preserving query params if feasible, or using `HTTP_REFERER`)
  - [x] Use `require_POST` or `http_method_names = ['post']` to reject GET requests
- [x] Task 3: Add URL pattern for toggle-status in `apps/tasks/urls.py` (AC: 2)
  - [x] Add `path('<uuid:pk>/toggle/', TaskToggleStatusView.as_view(), name='task-toggle-status')`
  - [x] Import `TaskToggleStatusView` from views
- [x] Task 4: Update default ordering for high-priority-first display (AC: 5)
  - [x] Update `TaskListView.get_queryset()` to apply a default sort when no explicit `?sort=` param is provided
  - [x] Default ordering: high priority first, then by created_at descending. Use Django's `Case`/`When` expressions to map priority to numeric values for proper ordering: `high=0, medium=1, low=2`
  - [x] When a user selects an explicit sort, that takes precedence over the default priority ordering
- [x] Task 5: Add "active" filter option to task list (AC: 4)
  - [x] In `TaskListView.get_queryset()`, add handling for `?status=active` that filters to `status__in=['todo', 'in_progress']`
  - [x] This supplements the existing `todo`, `in_progress`, `done` filters — `active` means "not done"
- [x] Task 6: Update task list template with toggle buttons and enhanced visuals (AC: 1, 2, 3, 5, 6)
  - [x] Add an inline `<form>` with POST to `task-toggle-status` for each task row, rendered as a checkbox or toggle button
  - [x] Include `{% csrf_token %}` in each toggle form
  - [x] For completed tasks: add `opacity-50` or similar CSS class in addition to existing strikethrough
  - [x] For overdue tasks: add `list-group-item-warning` or `border-start border-danger border-3` to highlight the entire row, not just a badge
  - [x] Update the status filter button group to include "Active" option between "All" and "To Do": `?status=active`
  - [x] Ensure toggle button click does NOT navigate to task detail (use `event.stopPropagation()` or separate element from the `<a>` tag)
- [x] Task 7: Update task detail template with toggle button and completion info (AC: 2, 3, 7)
  - [x] Add a "Mark Complete" / "Mark Incomplete" button on the detail page that POSTs to `task-toggle-status`
  - [x] Display `completed_at` timestamp when task is done (e.g., "Completed: Feb 10, 2026 14:30")
  - [x] Ensure the detail page reflects the enhanced visual distinction for completed tasks
- [x] Task 8: Write model tests for `completed_at` and helper methods (AC: 7)
  - [x] Test `mark_complete()` sets `status='done'` and `completed_at` to current time
  - [x] Test `mark_incomplete()` sets `status='todo'` and `completed_at=None`
  - [x] Test `completed_at` stays `None` for non-done tasks
  - [x] Test `mark_complete()` on already-done task doesn't change `completed_at`
  - [x] Add tests to `apps/tasks/tests/test_models.py`
- [x] Task 9: Write view tests for toggle-status endpoint (AC: 2, 7, 8)
  - [x] Test toggle requires authentication (redirects to login)
  - [x] Test toggle returns 404 for other user's task
  - [x] Test toggle GET request is rejected (405 Method Not Allowed)
  - [x] Test toggle on todo task changes to done and sets `completed_at`
  - [x] Test toggle on done task changes to todo and clears `completed_at`
  - [x] Test toggle shows success message
  - [x] Test toggle redirects to task-list
  - [x] Add tests to `apps/tasks/tests/test_views.py`
- [x] Task 10: Write view tests for enhanced filtering and default sort (AC: 4, 5)
  - [x] Test `?status=active` returns only todo and in_progress tasks
  - [x] Test default ordering places high-priority tasks before medium and low
  - [x] Test explicit `?sort=` param overrides default priority ordering
  - [x] Add tests to `apps/tasks/tests/test_views.py`
- [x] Task 11: Validate and verify (AC: 1-7)
  - [x] Run `ruff check .` with no errors
  - [x] Run `ruff format --check .` with no errors
  - [x] Run `pytest` with all tests passing
  - [x] Run `python manage.py check` with no issues

## Dev Notes

### Previous Story Insights

From Story 1.4 Dev Agent Record:
- All 102 tests pass (28 accounts + 38 tasks models/admin + 25 task views + 11 task forms), 99% coverage
- Views at 100% coverage, forms at 93% coverage
- `MESSAGE_TAGS` already configured in `base.py` to map Django error level (40) to Bootstrap `danger` class
- Class-based views use `LoginRequiredMixin` and `get_queryset()` user filtering for all views
- `is_overdue` returns falsy (None), not `False`, when `due_date` is None — use `not task.is_overdue` in templates rather than `task.is_overdue is False`
- **Gotcha**: `ruff --fix` may be needed for import sorting

### What Already Exists (from Story 1.4)

Much of Story 1.5's visual foundation is already in place from Story 1.4. The dev agent must NOT re-implement these — only enhance and add what's missing:

**Already implemented:**
- Priority field with `PRIORITY_CHOICES`: low, medium, high [Source: `apps/tasks/models.py`]
- Color-coded priority badges: high=`bg-danger`, medium=`bg-warning text-dark`, low=`bg-info` [Source: `apps/tasks/templates/tasks/task_list.html`, `task_detail.html`]
- Status filtering buttons: All, To Do, In Progress, Done [Source: `apps/tasks/templates/tasks/task_list.html`]
- Sort dropdown: priority, due date, created date (both directions) [Source: `apps/tasks/views.py` SORT_OPTIONS, `task_list.html`]
- Completed tasks display strikethrough + `text-muted` [Source: `task_list.html`, `task_detail.html`]
- Overdue badge indicator (`badge bg-danger`) [Source: `task_list.html`, `task_detail.html`]
- `is_overdue` property and `days_until_due` property on Task model [Source: `apps/tasks/models.py`]

**What's NEW in this story:**
- `completed_at` timestamp field (AC 7)
- Quick toggle button/checkbox for marking complete/incomplete without full edit (AC 2)
- "Active" filter (= not done) in the filter bar (AC 4)
- Default high-priority-first ordering when no sort selected (AC 5)
- Enhanced visual distinction for completed rows (e.g., reduced opacity) (AC 3)
- Enhanced overdue row highlighting (border/background, not just badge) (AC 6)

### Model Changes

[Source: architecture/data-models.md#Task Model]

Add to `Task` model:
```python
completed_at = models.DateTimeField(null=True, blank=True)
```

Add helper methods to the `Task` model:
```python
def mark_complete(self):
    """Mark task as done and record completion timestamp."""
    if self.status != 'done':
        self.status = 'done'
        self.completed_at = timezone.now()
        self.save(update_fields=['status', 'completed_at', 'updated_at'])

def mark_incomplete(self):
    """Mark task as not done and clear completion timestamp."""
    self.status = 'todo'
    self.completed_at = None
    self.save(update_fields=['status', 'completed_at', 'updated_at'])
```

**Migration**: This adds a nullable field — no data migration needed. Existing tasks with `status='done'` will have `completed_at=None` which is acceptable (they were completed before we tracked the timestamp).

### Toggle Status View

[Source: architecture/coding-standards.md#View Best Practices]
[Source: architecture/security-performance.md#User Isolation]

Create a POST-only view for quick status toggling:
```python
from django.views import View

class TaskToggleStatusView(LoginRequiredMixin, View):
    http_method_names = ['post']

    def post(self, request, pk):
        task = get_object_or_404(
            Task.objects.filter(user=request.user), pk=pk
        )
        if task.status != 'done':
            task.mark_complete()
            messages.success(request, f'Task "{task.title}" marked as complete!')
        else:
            task.mark_incomplete()
            messages.success(request, f'Task "{task.title}" marked as incomplete.')
        return redirect('task-list')
```

**URL pattern**: `path('<uuid:pk>/toggle/', TaskToggleStatusView.as_view(), name='task-toggle-status')`

**Security**: Uses `LoginRequiredMixin` + `user=request.user` filter, same pattern as all other views. POST-only prevents CSRF via GET.

### Default Priority Ordering

[Source: architecture/data-models.md#Query Patterns]
[Source: architecture/security-performance.md#Database Query Optimization]

To display high-priority tasks at top by default, use Django `Case`/`When`:
```python
from django.db.models import Case, When, IntegerField

PRIORITY_ORDER = Case(
    When(priority='high', then=0),
    When(priority='medium', then=1),
    When(priority='low', then=2),
    output_field=IntegerField(),
)
```

Apply in `get_queryset()` when no explicit sort is provided:
```python
if sort in SORT_OPTIONS:
    qs = qs.order_by(SORT_OPTIONS[sort])
else:
    qs = qs.order_by(PRIORITY_ORDER, '-created_at')
```

The existing composite index on `(user, priority)` supports this query pattern. [Source: architecture/data-models.md#Indexes]

### Template Updates — Toggle Button

[Source: architecture/coding-standards.md#CSRF Protection]

The task list template needs an inline form for each task that avoids interfering with the task detail link. Approach:

```html
<form method="post" action="{% url 'task-toggle-status' pk=task.pk %}"
      class="d-inline" onclick="event.stopPropagation();">
    {% csrf_token %}
    <button type="submit" class="btn btn-sm btn-outline-success"
            title="{% if task.status == 'done' %}Mark incomplete{% else %}Mark complete{% endif %}">
        {% if task.status == 'done' %}✓{% else %}○{% endif %}
    </button>
</form>
```

The `onclick="event.stopPropagation()"` prevents the form click from triggering the parent `<a>` tag navigation. Alternatively, restructure the list item so the toggle button is outside the `<a>` element.

### Enhanced Visual Distinction

[Source: architecture/source-tree.md#Static Files Organization]

For completed tasks (AC 3), add opacity reduction:
- Add CSS class `opacity-50` (Bootstrap 5 utility) to the entire list item when `task.status == 'done'`

For overdue tasks (AC 6), add row-level highlighting:
- Add `border-start border-danger border-3` to list items where `task.is_overdue` to create a left red border indicator
- This enhances the existing overdue badge with a row-level visual cue

### URL Configuration

[Source: architecture/source-tree.md#URL Naming Conventions]

New URL to add to `apps/tasks/urls.py`:
```python
path('<uuid:pk>/toggle/', TaskToggleStatusView.as_view(), name='task-toggle-status'),
```

URL name follows the `{model}-{action}` kebab-case convention.

### Project Structure

[Source: architecture/source-tree.md]

Files to modify for this story:
```
apps/tasks/
├── models.py              # MODIFY: Add completed_at field, mark_complete/incomplete methods
├── views.py               # MODIFY: Add TaskToggleStatusView, update default ordering
├── urls.py                # MODIFY: Add toggle-status URL pattern
└── templates/tasks/
    ├── task_list.html      # MODIFY: Add toggle buttons, active filter, enhanced visuals
    └── task_detail.html    # MODIFY: Add toggle button, show completed_at

apps/tasks/tests/
├── test_models.py         # MODIFY: Add completed_at and method tests
└── test_views.py          # MODIFY: Add toggle-status and filter/sort tests
```

No new files needed. This story only modifies existing files.

### Testing

**Test file locations**: `apps/tasks/tests/test_models.py`, `apps/tasks/tests/test_views.py`

[Source: architecture/testing-strategy.md]

**Test standards**:
- Use pytest with `pytest-django`
- Use `@pytest.mark.django_db` for database tests
- Use Factory Boy for test data — import existing factories: `from apps.tasks.tests.factories import TaskFactory` and `from apps.accounts.tests.factories import UserFactory`
- Use Django test `Client` with `client.force_login(user)` for view tests
- Descriptive test names: `test_toggle_status_marks_todo_task_as_done()`
- Target coverage: views 85%+, models 95%+

**View test pattern for toggle**:
```python
@pytest.mark.django_db
class TestTaskToggleStatusView:
    def test_toggle_requires_authentication(self, client):
        task = TaskFactory()
        url = reverse('task-toggle-status', kwargs={'pk': task.pk})
        response = client.post(url)
        assert response.status_code == 302
        assert '/accounts/login/' in response.url

    def test_toggle_todo_to_done(self, client):
        user = UserFactory()
        task = TaskFactory(user=user, status='todo')
        client.force_login(user)
        url = reverse('task-toggle-status', kwargs={'pk': task.pk})
        response = client.post(url)
        task.refresh_from_db()
        assert task.status == 'done'
        assert task.completed_at is not None
        assert response.status_code == 302
```

**Login URL**: The accounts app uses `LOGIN_URL = 'login'` (name, not path) — `LoginRequiredMixin` redirects to `settings.LOGIN_URL`. Tests should check for `/accounts/login/` in the redirect URL.

### Technical Constraints

[Source: architecture/tech-stack.md]
- Django 4.2 LTS
- Bootstrap 5.3 for responsive UI
- UUID primary keys — use `<uuid:pk>` in URL patterns
- SQLite for local dev

[Source: architecture/security-performance.md]
- Always filter by user for data isolation
- Use ORM (parameterized queries), no raw SQL
- CSRF token required in all forms (including toggle form)

### Naming Conventions

[Source: architecture/coding-standards.md#Naming Conventions]

- Python variables/functions: snake_case (`mark_complete`, `completed_at`)
- Python classes: PascalCase (`TaskToggleStatusView`)
- URL names: kebab-case (`task-toggle-status`)
- Templates: snake_case (no new templates needed)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Completion Notes
- All 11 tasks implemented successfully across 7 modified files
- 116 total tests pass (up from 102 in Story 1.4), 99% code coverage
- No new dependencies added
- `ruff check`, `ruff format --check`, `pytest`, and `manage.py check` all pass clean
- `ruff format` was needed after initial implementation to fix formatting in 4 files (migration, test_views.py, urls.py, views.py)
- Tasks 2-5 were implemented together since they all modify views.py
- Task 8 (model tests) was implemented alongside Task 1 (model changes)

### File List
| File | Action | Description |
|------|--------|-------------|
| `apps/tasks/models.py` | Modified | Added `completed_at` field, `mark_complete()`, `mark_incomplete()` methods |
| `apps/tasks/views.py` | Modified | Added `PRIORITY_ORDER`, active filter, default ordering, `TaskToggleStatusView` |
| `apps/tasks/urls.py` | Modified | Added toggle-status URL pattern |
| `apps/tasks/templates/tasks/task_list.html` | Modified | Toggle buttons, active filter, opacity-50 for done, border for overdue |
| `apps/tasks/templates/tasks/task_detail.html` | Modified | Toggle button, completed_at display |
| `apps/tasks/migrations/0002_task_completed_at.py` | Added | Migration for completed_at field |
| `apps/tasks/tests/test_models.py` | Modified | 4 new tests for mark_complete/mark_incomplete |
| `apps/tasks/tests/test_views.py` | Modified | 10 new tests: 7 toggle-status + 3 filter/sort |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-15 | 0.1 | Initial story draft | SM Agent (Bob) |
| 2026-02-15 | 1.0 | Implementation complete — all 11 tasks done, 116 tests passing | Dev Agent (James) |

## QA Results

### Review Date: 2026-02-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent.** The implementation is clean, well-structured, and follows all project conventions consistently. The 8 modified files are cohesive and focused on the story requirements with no unnecessary changes. Key positives:

- Model methods (`mark_complete`/`mark_incomplete`) are well-designed with idempotency guard on `mark_complete()` and efficient `update_fields` saves
- `TaskToggleStatusView` follows the same security pattern (LoginRequiredMixin + user-filtered queryset) as all other views
- `PRIORITY_ORDER` as a module-level `Case`/`When` constant is efficient and readable
- `SORT_OPTIONS` whitelist prevents arbitrary ordering injection
- Template changes cleanly separate toggle forms from navigation links (no `event.stopPropagation()` hack needed)

### Requirements Traceability

| AC | Requirement | Test Coverage | Status |
|----|-------------|---------------|--------|
| 1 | Priority field with High/Medium/Low + color coding | Pre-existing from 1.4: `test_default_priority_is_medium`, `test_invalid_priority_fails_validation`. Template badges verified visually. | Covered |
| 2 | Toggle button for marking complete/incomplete | `test_toggle_todo_to_done`, `test_toggle_done_to_todo`, `test_toggle_get_request_rejected`, `test_toggle_requires_authentication`, `test_toggle_returns_404_for_other_users_task` | Covered |
| 3 | Completed tasks visually distinguished | Template: `opacity-50` on list items, `text-decoration-line-through text-muted` on titles. Functional behavior tested via toggle view tests. | Covered |
| 4 | Filter by completion status (all, active, completed) | `test_active_filter_returns_only_non_done_tasks`, `test_filter_by_status` (pre-existing for individual statuses) | Covered |
| 5 | High-priority tasks at top of list | `test_default_ordering_high_priority_first`, `test_explicit_sort_overrides_default_priority` | Covered |
| 6 | Overdue tasks highlighted with warning indicators | Template: `border-start border-danger border-3` + badge. `is_overdue` property well-tested in model tests (5 tests). | Covered |
| 7 | Completion timestamps tracked | `test_mark_complete_sets_status_and_completed_at`, `test_mark_incomplete_sets_todo_and_clears_completed_at`, `test_completed_at_is_none_for_new_tasks`, `test_mark_complete_on_already_done_task_is_noop` | Covered |

### Refactoring Performed

None. The implementation is clean and well-structured. No refactoring needed.

### Compliance Check

- Coding Standards: ✓ Naming conventions (PascalCase classes, snake_case functions, kebab-case URLs), import organization, Django patterns all followed correctly
- Project Structure: ✓ All files in correct locations under `apps/tasks/`, migration auto-generated, no unnecessary new files
- Testing Strategy: ✓ pytest + Factory Boy, `@pytest.mark.django_db`, descriptive test names, 99% coverage (exceeds 90%+ target)
- All ACs Met: ✓ All 7 acceptance criteria verified with test coverage

### Improvements Checklist

- [x] All acceptance criteria have test coverage
- [x] User isolation enforced on toggle view
- [x] CSRF protection on all toggle forms
- [x] POST-only enforcement on state-changing endpoint
- [x] Efficient DB queries with `update_fields` and `prefetch_related`
- [ ] Consider adding test for "marked as incomplete" success message (currently only "marked as complete" message is tested in `test_toggle_shows_success_message_on_complete`)
- [ ] Pre-existing: The sort-by-priority dropdown options (`?sort=priority` / `?sort=-priority`) use alphabetical ordering on the text field, which gives unintuitive results with all 3 priorities (e.g., ascending = high, low, medium). The default ordering via `PRIORITY_ORDER` Case/When is correct. This pre-dates Story 1.5 and is not a blocker.

### Security Review

No security concerns found. The implementation follows all established patterns:
- `LoginRequiredMixin` on `TaskToggleStatusView`
- User isolation via `Task.objects.filter(user=request.user)`
- `http_method_names = ["post"]` prevents GET-based state changes
- `{% csrf_token %}` in all toggle forms (both list and detail templates)
- `SORT_OPTIONS` whitelist prevents arbitrary `ORDER BY` injection

### Performance Considerations

No performance concerns found:
- `PRIORITY_ORDER` Case/When is defined at module level (computed once per process, not per request)
- `mark_complete()`/`mark_incomplete()` use `save(update_fields=...)` for targeted DB writes
- Existing indexes on `(user, status)` and `(user, priority)` support the new queries
- `prefetch_related("tags")` maintained on list and detail views

### Files Modified During Review

None. No files were modified during QA review.

### Gate Status

Gate: PASS → docs/qa/gates/1.5-basic-priority-and-status-management.yml

### Recommended Status

✓ Ready for Done — All acceptance criteria met, 116 tests passing, 99% coverage, clean linting, no security or performance concerns. Two minor suggestions noted in Improvements Checklist (non-blocking).
