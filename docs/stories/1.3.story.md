# Story 1.3: Basic Task Model and Database Design

## Status

Done

## Story

**As a** developer,
**I want** well-designed database models for tasks and future tag relationships,
**so that** the application can handle complex queries efficiently.

## Acceptance Criteria

1. Task model includes title, description, priority, due_date, completed, created_at, updated_at fields
2. User foreign key properly configured for task ownership
3. Database migrations created and applied successfully
4. Proper indexing on frequently queried fields (user_id, priority, due_date, completed)
5. Model validation ensures data integrity (required fields, date formats, priority choices)
6. Task model includes __str__ method for admin interface readability
7. Django admin interface configured for task management during development

## Tasks / Subtasks

- [x] Task 1: Create Task model in `apps/tasks/models.py` (AC: 1, 2, 5, 6)
  - [x] Define Task model with UUID primary key (`id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)`)
  - [x] Add `user` ForeignKey to `settings.AUTH_USER_MODEL` with `on_delete=models.CASCADE`, `related_name='tasks'`
  - [x] Add `title` CharField(max_length=200), required
  - [x] Add `description` TextField(blank=True)
  - [x] Add `status` CharField with STATUS_CHOICES: `('todo', 'To Do'), ('in_progress', 'In Progress'), ('done', 'Done')`, default='todo', db_index=True
  - [x] Add `priority` CharField with PRIORITY_CHOICES: `('low', 'Low'), ('medium', 'Medium'), ('high', 'High')`, default='medium', db_index=True
  - [x] Add `due_date` DateField(null=True, blank=True)
  - [x] Add `position` IntegerField(default=0) for manual ordering
  - [x] Add `created_at` DateTimeField(auto_now_add=True)
  - [x] Add `updated_at` DateTimeField(auto_now=True)
  - [x] Implement `__str__` method: `return f"{self.title} ({self.get_status_display()})"`
  - [x] Implement `is_overdue` property: returns True if `due_date < today` and `status != 'done'`
  - [x] Implement `days_until_due` property: returns integer days or None
  - [x] Set `db_table = 'tasks'` in Meta
  - [x] Set `ordering = ['position', '-created_at']` in Meta
  - [x] Note: AC1 mentions "completed" field but architecture uses "status" with choices (todo/in_progress/done). Follow architecture — status field covers the completed state via `status='done'`.
- [x] Task 2: Add composite indexes for query optimization (AC: 4)
  - [x] Add `models.Index(fields=['user', 'status'])` — filter by user's tasks with status
  - [x] Add `models.Index(fields=['user', 'priority'])` — filter by user's tasks with priority
  - [x] Add `models.Index(fields=['user', 'due_date'])` — filter by user's tasks by deadline
  - [x] Add `models.Index(fields=['user', 'created_at'])` — sort user's tasks by creation date
- [x] Task 3: Create Tag model in `apps/tasks/models.py` (prepares for Epic 2)
  - [x] Define Tag model with UUID primary key
  - [x] Add `user` ForeignKey to `settings.AUTH_USER_MODEL` with `on_delete=models.CASCADE`, `related_name='tags'`
  - [x] Add `name` CharField(max_length=50)
  - [x] Add `color` CharField(max_length=7) with COLOR_CHOICES (8 predefined hex colors), default='#4ECDC4'
  - [x] Add `created_at` DateTimeField(auto_now_add=True)
  - [x] Implement `__str__` method: `return f"{self.name} ({self.color})"`
  - [x] Set `db_table = 'tags'`, `ordering = ['name']`, `unique_together = [['user', 'name']]`
  - [x] Add `models.Index(fields=['user', 'name'])` index
  - [x] Note: Tag model is included now because Task has a ManyToManyField('Tag') in the architecture. Creating both together avoids a later migration that would need to alter Task.
- [x] Task 4: Add ManyToMany relationship between Task and Tag
  - [x] Add `tags = models.ManyToManyField('Tag', related_name='tasks', blank=True)` to Task model
- [x] Task 5: Register apps in settings (AC: 3)
  - [x] Verify `apps.tasks` is already in `INSTALLED_APPS` in `base.py` (should be from Story 1.1)
  - [x] Fix `apps/tasks/apps.py` if `name` field doesn't include `apps.` prefix
- [x] Task 6: Generate and apply migrations (AC: 3)
  - [x] Run `python manage.py makemigrations tasks`
  - [x] Review generated migration file for correctness
  - [x] Run `python manage.py migrate`
  - [x] Verify migration applied successfully
- [x] Task 7: Configure Django Admin for Task and Tag (AC: 7)
  - [x] Register Task model with custom `TaskAdmin` class in `apps/tasks/admin.py`
  - [x] Include `list_display`: id (short), title, user, status, priority, due_date, created_at
  - [x] Include `list_filter`: status, priority, due_date, created_at
  - [x] Include `search_fields`: title, description
  - [x] Include `list_editable`: status, priority (for quick updates)
  - [x] Include `readonly_fields`: id, created_at, updated_at
  - [x] Register Tag model with custom `TagAdmin` class
  - [x] Include `list_display`: name, user, color, created_at
  - [x] Include `list_filter`: color, user
- [x] Task 8: Create test factories (AC: 5)
  - [x] Create `apps/tasks/tests/` package (delete `tests.py`, create `__init__.py`)
  - [x] Create `apps/tasks/tests/factories.py` with `TaskFactory` and `TagFactory`
  - [x] TaskFactory: title (Faker sentence), description (Faker paragraph), status='todo', priority='medium', due_date (today + 7 days), user (SubFactory UserFactory)
  - [x] TagFactory: name (Sequence), color='#4ECDC4', user (SubFactory UserFactory)
  - [x] TaskFactory must handle `tags` ManyToMany via `@factory.post_generation`
- [x] Task 9: Write model tests (AC: 1, 2, 5, 6)
  - [x] Create `apps/tasks/tests/test_models.py`
  - [x] Test task creation with all fields
  - [x] Test task has UUID primary key
  - [x] Test task belongs to user (ForeignKey)
  - [x] Test task `__str__` method returns `"title (status_display)"`
  - [x] Test default status is 'todo' and default priority is 'medium'
  - [x] Test `is_overdue` property: overdue when due_date past and status != done
  - [x] Test `is_overdue` property: not overdue when status is done
  - [x] Test `is_overdue` property: not overdue when due_date is in future
  - [x] Test `is_overdue` property: not overdue when due_date is None
  - [x] Test `days_until_due` property
  - [x] Test status choices validation (only todo/in_progress/done allowed)
  - [x] Test priority choices validation (only low/medium/high allowed)
  - [x] Test title is required (blank title fails validation)
  - [x] Test due_date is optional (null=True)
  - [x] Test task-tag ManyToMany relationship
  - [x] Test tag creation with uniqueness per user
  - [x] Test tag `__str__` method
  - [x] Test cascade delete: deleting user deletes their tasks
  - [x] Test cascade delete: deleting user deletes their tags
  - [x] Test task table name is 'tasks'
  - [x] Test tag table name is 'tags'
- [x] Task 10: Write admin tests
  - [x] Create `apps/tasks/tests/test_admin.py`
  - [x] Test Task is registered in admin
  - [x] Test Tag is registered in admin
  - [x] Test admin task list page loads
  - [x] Test admin tag list page loads
- [x] Task 11: Validate and verify (AC: 1-7)
  - [x] Run `ruff check .` with no errors
  - [x] Run `ruff format --check .` with no errors
  - [x] Run `pytest` with all tests passing
  - [x] Run `python manage.py check` with no issues
  - [x] Verify models appear in Django admin

## Dev Notes

### Previous Story Insights

From Story 1.2 Dev Agent Record:
- Custom User model with UUID PK is already implemented at `apps/accounts/models.py`
- `AUTH_USER_MODEL = 'accounts.User'` is set in `base.py`
- Use `settings.AUTH_USER_MODEL` for ForeignKey references (not direct import)
- Database was reset during Story 1.2 (deleted `db.sqlite3`, regenerated migrations) — current DB is clean with only accounts migration
- Existing `UserFactory` at `apps/accounts/tests/factories.py` — import from there, don't duplicate
- Password in UserFactory is `testpass123!!` (meets 12-char minimum)
- **Gotcha**: Django's `password_reset_confirm` URL name uses underscores internally; project uses kebab-case URL names
- **Gotcha**: When creating Django apps with `django-admin startapp`, must fix `name` in `apps.py` to include `apps.` prefix
- **Gotcha**: `ruff --fix` may be needed to clean up unused imports in Django boilerplate

### Task Model Specification

[Source: architecture/data-models.md#Task Model]

```python
class Task(models.Model):
    STATUS_CHOICES = [
        ('todo', 'To Do'),
        ('in_progress', 'In Progress'),
        ('done', 'Done'),
    ]

    PRIORITY_CHOICES = [
        ('low', 'Low'),
        ('medium', 'Medium'),
        ('high', 'High'),
    ]

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='tasks'
    )
    title = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='todo', db_index=True)
    priority = models.CharField(max_length=10, choices=PRIORITY_CHOICES, default='medium', db_index=True)
    due_date = models.DateField(null=True, blank=True)
    position = models.IntegerField(default=0, help_text="For manual ordering")
    tags = models.ManyToManyField('Tag', related_name='tasks', blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'tasks'
        ordering = ['position', '-created_at']
        indexes = [
            models.Index(fields=['user', 'status']),
            models.Index(fields=['user', 'priority']),
            models.Index(fields=['user', 'due_date']),
            models.Index(fields=['user', 'created_at']),
        ]

    def __str__(self):
        return f"{self.title} ({self.get_status_display()})"

    @property
    def is_overdue(self):
        from django.utils import timezone
        return (
            self.due_date
            and self.due_date < timezone.now().date()
            and self.status != 'done'
        )

    @property
    def days_until_due(self):
        from django.utils import timezone
        if not self.due_date:
            return None
        delta = self.due_date - timezone.now().date()
        return delta.days
```

**AC Clarification**: AC1 lists a "completed" field, but the architecture uses a `status` CharField with choices (todo/in_progress/done). The status field covers the completed state via `status='done'`. Follow the architecture specification.

### Tag Model Specification

[Source: architecture/data-models.md#Tag Model]

```python
class Tag(models.Model):
    COLOR_CHOICES = [
        ('#FF6B6B', 'Red'),
        ('#4ECDC4', 'Teal'),
        ('#45B7D1', 'Blue'),
        ('#FFA07A', 'Orange'),
        ('#98D8C8', 'Mint'),
        ('#F7DC6F', 'Yellow'),
        ('#BB8FCE', 'Purple'),
        ('#85C1E2', 'Sky Blue'),
    ]

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='tags'
    )
    name = models.CharField(max_length=50)
    color = models.CharField(max_length=7, choices=COLOR_CHOICES, default='#4ECDC4')
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = 'tags'
        ordering = ['name']
        unique_together = [['user', 'name']]
        indexes = [
            models.Index(fields=['user', 'name']),
        ]

    def __str__(self):
        return f"{self.name} ({self.color})"
```

### Database Indexes

[Source: architecture/data-models.md#Database Constraints]

Composite indexes for common queries:
- `(user, status)` — Filter user's tasks by status
- `(user, priority)` — Filter user's tasks by priority
- `(user, due_date)` — Filter user's tasks by deadline
- `(user, created_at)` — Sort user's tasks by creation date
- `(user, name)` — on Tag model for unique constraint + lookup

### Cascade Behavior

[Source: architecture/data-models.md#Foreign Key Constraints]

- Deleting a user deletes all their tasks (CASCADE)
- Deleting a user deletes all their tags (CASCADE)
- Deleting a tag removes it from task_tags join table (ManyToMany cascade)
- Deleting a task removes entries from task_tags join table (ManyToMany cascade)

### Project Structure

[Source: architecture/source-tree.md]

Files to create/modify for this story:

```
apps/tasks/
├── models.py              # Task and Tag models (modify existing boilerplate)
├── admin.py               # TaskAdmin and TagAdmin (modify)
├── apps.py                # Verify name = 'apps.tasks' (check)
└── tests/                 # Test package (create, replace tests.py)
    ├── __init__.py
    ├── factories.py       # TaskFactory, TagFactory
    ├── test_models.py     # Model tests
    └── test_admin.py      # Admin tests
```

The `apps/tasks/` directory already exists from Story 1.1 with boilerplate files (`__init__.py`, `admin.py`, `apps.py`, `models.py`, `tests.py`, `urls.py`, `views.py`, `migrations/`).

### Naming Conventions

[Source: architecture/coding-standards.md#Naming Conventions]

- Python variables/functions: snake_case
- Python classes: PascalCase
- Constants: UPPER_SNAKE_CASE (e.g., `STATUS_CHOICES`, `PRIORITY_CHOICES`)
- URL names: kebab-case (e.g., `task-list`, `task-detail`)
- Templates: snake_case in `templates/tasks/` directory
- Import style: `from apps.tasks.models import Task, Tag`
- Use `from django.conf import settings` then `settings.AUTH_USER_MODEL` for FK references

### Query Patterns

[Source: architecture/data-models.md#Query Patterns]

```python
# Prefetch tags to avoid N+1
tasks = Task.objects.filter(user=request.user).prefetch_related('tags')

# Filter by status
todo_tasks = Task.objects.filter(user=request.user, status='todo')

# Overdue tasks
overdue = Task.objects.filter(
    user=request.user,
    due_date__lt=timezone.now().date(),
    status__in=['todo', 'in_progress']
)
```

### Testing

**Test file location**: `apps/tasks/tests/` (package with separate files per concern)

[Source: architecture/testing-strategy.md]

**Test standards**:
- Use pytest as test framework with `pytest-django`
- Use Factory Boy for test data generation
- Use `@pytest.mark.django_db` for database tests
- Descriptive test names: `test_task_is_overdue_when_due_date_past_and_not_done()`
- Minimum 80% code coverage target, models target 95%+

**Test settings** (`test.py`): Already configured with SQLite in-memory and faster password hashing (`MD5PasswordHasher`).

**Import UserFactory**: `from apps.accounts.tests.factories import UserFactory` (already exists from Story 1.2)

**Factory patterns from architecture** [Source: architecture/testing-strategy.md#Factory Boy Factories]:

```python
class TaskFactory(DjangoModelFactory):
    class Meta:
        model = Task

    title = factory.Faker('sentence', nb_words=4)
    description = factory.Faker('paragraph')
    status = 'todo'
    priority = 'medium'
    due_date = factory.LazyFunction(lambda: date.today() + timedelta(days=7))
    user = factory.SubFactory('apps.accounts.tests.factories.UserFactory')

    @factory.post_generation
    def tags(self, create, extracted, **kwargs):
        if not create:
            return
        if extracted:
            for tag in extracted:
                self.tags.add(tag)

class TagFactory(DjangoModelFactory):
    class Meta:
        model = Tag

    name = factory.Sequence(lambda n: f"Tag{n}")
    color = "#4ECDC4"
    user = factory.SubFactory('apps.accounts.tests.factories.UserFactory')
```

### Technical Constraints

[Source: architecture/tech-stack.md]
- Django 4.2 LTS
- PostgreSQL 14+ in production, SQLite for local dev
- Python 3.10+

[Source: architecture/security-performance.md]
- Always use ORM (parameterized queries), no raw SQL
- Always filter by user for data isolation
- Use `select_related` for ForeignKey, `prefetch_related` for ManyToMany

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No blocking issues. One test assertion was initially too strict (`is False` vs `not`) for `is_overdue` when `due_date=None` — Python's `and` short-circuits returning `None` (falsy) rather than `False`. Fixed test to use `assert not task.is_overdue`. Migration import sorting required `ruff --fix`.

### Completion Notes
- All 66 tests pass (28 accounts + 38 tasks), 99% overall coverage
- Task and Tag models at 100% coverage, admin at 100%
- `manage.py check` — no issues
- `ruff check .` — all checks passed
- `ruff format --check .` — all files formatted
- Migration `0001_initial.py` creates both Tag and Task models with all indexes
- Tag model defined before Task in models.py to resolve forward reference for ManyToManyField

### File List

**New files:**
- `apps/tasks/tests/__init__.py` — Test package init
- `apps/tasks/tests/factories.py` — TaskFactory and TagFactory using Factory Boy
- `apps/tasks/tests/test_models.py` — 32 model tests (Task and Tag creation, UUID PK, __str__, defaults, is_overdue, days_until_due, validation, M2M, cascade delete, table names)
- `apps/tasks/tests/test_admin.py` — 6 admin tests (registration, list page loads)
- `apps/tasks/migrations/0001_initial.py` — Initial migration for Task and Tag models

**Modified files:**
- `apps/tasks/models.py` — Task model (UUID PK, status/priority choices, indexes, is_overdue/days_until_due properties) and Tag model (UUID PK, color choices, user-scoped uniqueness)
- `apps/tasks/admin.py` — TaskAdmin (list_display, list_filter, search_fields, list_editable, readonly_fields) and TagAdmin

**Deleted files:**
- `apps/tasks/tests.py` — Replaced by tests/ package

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 0.1 | Initial story draft | SM Agent (Bob) |
| 2026-02-10 | 1.0 | Implementation complete — all tasks done, 66 tests passing, 99% coverage | Dev Agent (James) |
