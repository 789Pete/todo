# Story 1.4: Task CRUD Operations

## Status

Done

## Story

**As a** user,
**I want** to create, view, edit, and delete my tasks,
**so that** I can manage my work effectively.

## Acceptance Criteria

1. Task creation form with title, description, priority, and due date fields
2. Task list view displaying all user's tasks with sorting by priority and due date
3. Task detail view showing full task information with edit and delete options
4. Task edit form pre-populated with existing data and update functionality
5. Task deletion with confirmation dialog to prevent accidental removal
6. Form validation prevents empty titles and handles invalid date inputs
7. Success/error messages displayed for all CRUD operations
8. All views properly restrict access to task owner only

## Tasks / Subtasks

- [x] Task 1: Create TaskForm in `apps/tasks/forms.py` (AC: 1, 6)
  - [x] Create `apps/tasks/forms.py` file
  - [x] Define `TaskForm` as `forms.ModelForm` with `model = Task`
  - [x] Include fields: `title`, `description`, `status`, `priority`, `due_date`
  - [x] Add `clean_title` method: strip whitespace, reject empty/blank titles
  - [x] Add Bootstrap CSS classes to form widgets using `widgets` dict in Meta (e.g., `'title': forms.TextInput(attrs={'class': 'form-control'})`)
  - [x] Add `due_date` widget with `type='date'` attribute for HTML5 date picker
  - [x] Add custom error messages for `title` (required) and `due_date` (invalid format)
- [x] Task 2: Create Task List View in `apps/tasks/views.py` (AC: 2, 8)
  - [x] Import `LoginRequiredMixin` from `django.contrib.auth.mixins`
  - [x] Create `TaskListView(LoginRequiredMixin, ListView)`:
    - [x] `model = Task`
    - [x] `template_name = 'tasks/task_list.html'`
    - [x] `context_object_name = 'tasks'`
    - [x] `paginate_by = 25`
    - [x] Override `get_queryset()` to filter by `user=self.request.user` with `.prefetch_related('tags')`
    - [x] Support optional query params for sorting: `?sort=priority`, `?sort=due_date`, `?sort=created_at` (default: model ordering)
    - [x] Support optional `?status=` filter param (todo, in_progress, done)
- [x] Task 3: Create Task Detail View in `apps/tasks/views.py` (AC: 3, 8)
  - [x] Create `TaskDetailView(LoginRequiredMixin, DetailView)`:
    - [x] `model = Task`
    - [x] `template_name = 'tasks/task_detail.html'`
    - [x] `context_object_name = 'task'`
    - [x] Override `get_queryset()` to filter by `user=self.request.user` (ensures 404 for other users' tasks)
- [x] Task 4: Create Task Create View in `apps/tasks/views.py` (AC: 1, 6, 7, 8)
  - [x] Create `TaskCreateView(LoginRequiredMixin, CreateView)`:
    - [x] `model = Task`
    - [x] `form_class = TaskForm`
    - [x] `template_name = 'tasks/task_form.html'`
    - [x] Override `form_valid()` to set `form.instance.user = self.request.user` before save
    - [x] Add success message via `django.contrib.messages`: `'Task "{task.title}" created successfully!'`
    - [x] Set `success_url` to `reverse_lazy('task-list')` or redirect to task detail
- [x] Task 5: Create Task Update View in `apps/tasks/views.py` (AC: 4, 6, 7, 8)
  - [x] Create `TaskUpdateView(LoginRequiredMixin, UpdateView)`:
    - [x] `model = Task`
    - [x] `form_class = TaskForm`
    - [x] `template_name = 'tasks/task_form.html'`
    - [x] Override `get_queryset()` to filter by `user=self.request.user`
    - [x] Add success message: `'Task "{task.title}" updated successfully!'`
    - [x] Set `success_url` to redirect to task detail page
- [x] Task 6: Create Task Delete View in `apps/tasks/views.py` (AC: 5, 7, 8)
  - [x] Create `TaskDeleteView(LoginRequiredMixin, DeleteView)`:
    - [x] `model = Task`
    - [x] `template_name = 'tasks/task_confirm_delete.html'`
    - [x] Override `get_queryset()` to filter by `user=self.request.user`
    - [x] Add success message: `'Task "{task.title}" deleted successfully.'`
    - [x] Set `success_url = reverse_lazy('task-list')`
- [x] Task 7: Configure URL patterns in `apps/tasks/urls.py` (AC: 1-5)
  - [x] Import views from `apps.tasks.views`
  - [x] Define `app_name = 'tasks'` (optional, but NOT used if URL names are flat like `task-list`)
  - [x] **IMPORTANT**: Do NOT set `app_name` — the architecture uses flat URL names (`task-list`, `task-detail`, etc.) without namespace. Namespaced URLs would require `tasks:task-list` everywhere.
  - [x] Add URL patterns:
    - [x] `path('', TaskListView.as_view(), name='task-list')`
    - [x] `path('create/', TaskCreateView.as_view(), name='task-create')`
    - [x] `path('<uuid:pk>/', TaskDetailView.as_view(), name='task-detail')`
    - [x] `path('<uuid:pk>/edit/', TaskUpdateView.as_view(), name='task-update')`
    - [x] `path('<uuid:pk>/delete/', TaskDeleteView.as_view(), name='task-delete')`
  - [x] Root URL config already has `path("tasks/", include("apps.tasks.urls"))` — no change needed there
- [x] Task 8: Create task list template `apps/tasks/templates/tasks/task_list.html` (AC: 2)
  - [x] Create directory structure: `apps/tasks/templates/tasks/`
  - [x] Extend `base.html`
  - [x] Display page title "My Tasks" with "New Task" button linking to `task-create`
  - [x] Show sorting controls (links/buttons for priority, due date, created date)
  - [x] Show status filter tabs/links (All, To Do, In Progress, Done)
  - [x] Iterate over `tasks` and display each task with: title (link to detail), status badge, priority badge (color-coded), due date, overdue indicator
  - [x] Show empty state message when no tasks exist: "No tasks yet. Create your first task!"
  - [x] Include pagination controls if paginated
- [x] Task 9: Create task detail template `apps/tasks/templates/tasks/task_detail.html` (AC: 3)
  - [x] Extend `base.html`
  - [x] Display full task info: title, description, status, priority (color-coded), due date, created/updated timestamps
  - [x] Show overdue warning if `task.is_overdue`
  - [x] Show days until due if `task.days_until_due` is not None
  - [x] Show tags as badges (preparing for Epic 2)
  - [x] Include "Edit" button linking to `task-update`
  - [x] Include "Delete" button linking to `task-delete`
  - [x] Include "Back to Tasks" link to `task-list`
- [x] Task 10: Create task form template `apps/tasks/templates/tasks/task_form.html` (AC: 1, 4, 6)
  - [x] Extend `base.html`
  - [x] Display dynamic title: "Create Task" or "Edit Task" based on `object` existence
  - [x] Render form with `{% csrf_token %}`
  - [x] Show non-field errors at top
  - [x] Render each field with Bootstrap styling, field-specific error messages, and help text
  - [x] Include "Save" submit button and "Cancel" link back to task list
- [x] Task 11: Create task delete confirmation template `apps/tasks/templates/tasks/task_confirm_delete.html` (AC: 5)
  - [x] Extend `base.html`
  - [x] Show confirmation message: "Are you sure you want to delete '{task.title}'?"
  - [x] Show task details (title, status, priority) for context
  - [x] Include form with POST method and `{% csrf_token %}`
  - [x] "Delete" submit button (styled danger/red) and "Cancel" link
- [x] Task 12: Update navbar to include Tasks link (AC: 2)
  - [x] Update `templates/includes/navbar.html` to add "My Tasks" navigation link pointing to `task-list`
  - [x] Only show for authenticated users
- [x] Task 13: Write view tests in `apps/tasks/tests/test_views.py` (AC: 1-8)
  - [x] Test task list requires authentication (redirects to login)
  - [x] Test task list shows only current user's tasks
  - [x] Test task list pagination works
  - [x] Test task list sorting by priority
  - [x] Test task list sorting by due_date
  - [x] Test task list filtering by status
  - [x] Test task detail requires authentication
  - [x] Test task detail shows task info
  - [x] Test task detail returns 404 for other user's task
  - [x] Test task create requires authentication
  - [x] Test task create GET shows empty form
  - [x] Test task create POST with valid data creates task and redirects
  - [x] Test task create POST assigns task to logged-in user
  - [x] Test task create POST with invalid data (empty title) shows form errors
  - [x] Test task create POST shows success message
  - [x] Test task update requires authentication
  - [x] Test task update GET pre-populates form with existing data
  - [x] Test task update POST with valid data updates task and redirects
  - [x] Test task update returns 404 for other user's task
  - [x] Test task update POST shows success message
  - [x] Test task delete requires authentication
  - [x] Test task delete GET shows confirmation page
  - [x] Test task delete POST deletes task and redirects to list
  - [x] Test task delete returns 404 for other user's task
  - [x] Test task delete POST shows success message
- [x] Task 14: Write form tests in `apps/tasks/tests/test_forms.py` (AC: 6)
  - [x] Test TaskForm with valid data
  - [x] Test TaskForm rejects empty title
  - [x] Test TaskForm rejects whitespace-only title
  - [x] Test TaskForm accepts optional description
  - [x] Test TaskForm accepts optional due_date
  - [x] Test TaskForm validates status choices
  - [x] Test TaskForm validates priority choices
  - [x] Test TaskForm includes correct fields
- [x] Task 15: Validate and verify (AC: 1-8)
  - [x] Run `ruff check .` with no errors
  - [x] Run `ruff format --check .` with no errors
  - [x] Run `pytest` with all tests passing
  - [x] Run `python manage.py check` with no issues
  - [x] Manually verify: create, view, edit, delete task flow works in browser

## Dev Notes

### Previous Story Insights

From Story 1.3 Dev Agent Record:
- Task and Tag models are implemented at `apps/tasks/models.py` with UUID PKs
- Task model has: title, description, status (todo/in_progress/done), priority (low/medium/high), due_date, position, tags (M2M), created_at, updated_at
- Task has `is_overdue` property and `days_until_due` property
- Tag model also exists (created early for M2M field resolution)
- Migration `0001_initial.py` already applied — DB schema is ready
- All 66 tests pass (28 accounts + 38 tasks)
- `is_overdue` returns falsy (None) not `False` when due_date is None — use `not task.is_overdue` in templates, not `task.is_overdue is False`
- **Gotcha**: `ruff --fix` may be needed for import sorting

### Views Architecture

[Source: architecture/coding-standards.md#View Best Practices]

Use **class-based views** for CRUD operations:
- `ListView` for task list with `get_queryset()` filtering by user
- `CreateView` with `form_valid()` to assign user
- `UpdateView` with `get_queryset()` filtering by user (returns 404 for unauthorized)
- `DeleteView` with `get_queryset()` filtering by user
- `DetailView` with `get_queryset()` filtering by user

Always use `LoginRequiredMixin` as the **first** mixin (MRO matters).

Always validate user ownership by overriding `get_queryset()`:
```python
def get_queryset(self):
    return Task.objects.filter(user=self.request.user)
```

[Source: architecture/security-performance.md#User Isolation]

### Form Specification

[Source: architecture/security-performance.md#Form Validation]
[Source: architecture/coding-standards.md#Security Standards]

```python
class TaskForm(forms.ModelForm):
    class Meta:
        model = Task
        fields = ['title', 'description', 'status', 'priority', 'due_date']

    def clean_title(self):
        title = self.cleaned_data['title']
        title = title.strip()
        if not title:
            raise ValidationError("Title cannot be empty")
        return title
```

Exclude `user`, `position`, `tags`, `created_at`, `updated_at` from the form — `user` is set in `form_valid()`, others are auto-managed or handled in future stories.

### URL Configuration

[Source: architecture/source-tree.md#URL Naming Conventions]

```python
# apps/tasks/urls.py
urlpatterns = [
    path('', views.TaskListView.as_view(), name='task-list'),
    path('create/', views.TaskCreateView.as_view(), name='task-create'),
    path('<uuid:pk>/', views.TaskDetailView.as_view(), name='task-detail'),
    path('<uuid:pk>/edit/', views.TaskUpdateView.as_view(), name='task-update'),
    path('<uuid:pk>/delete/', views.TaskDeleteView.as_view(), name='task-delete'),
]
```

URL name pattern: `{model}-{action}` using kebab-case. The root URL config already has `path("tasks/", include("apps.tasks.urls"))`.

**IMPORTANT**: Do NOT set `app_name` in `apps/tasks/urls.py`. The architecture uses flat URL names (`task-list`) not namespaced (`tasks:task-list`). Setting `app_name` would break `reverse('task-list')`.

### Template Structure

[Source: architecture/source-tree.md#Template Organization]

Templates go in `apps/tasks/templates/tasks/`:
```
apps/tasks/templates/tasks/
├── task_list.html            # Main task list view
├── task_detail.html          # Single task view
├── task_form.html            # Create/edit task (shared)
└── task_confirm_delete.html  # Delete confirmation
```

All templates extend `base.html` which already provides:
- Bootstrap 5.3 CSS/JS (via CDN)
- Navbar (`includes/navbar.html`)
- Django messages display (success/error alerts with dismiss button)
- Footer (`includes/footer.html`)
- `base.css` and `base.js` static files
- `{% block title %}`, `{% block content %}`, `{% block extra_css %}`, `{% block extra_js %}` blocks

### Messages Framework

[Source: architecture/error-handling-strategy.md#Django Messages Framework]

Use `django.contrib.messages` for user feedback:
```python
from django.contrib import messages

messages.success(request, 'Task created successfully!')
messages.error(request, 'Please correct the errors below.')
```

The `base.html` already renders messages as Bootstrap alerts with dismiss buttons. Message tags map to Bootstrap alert classes: `success`, `error` (maps to `danger` — may need `MESSAGE_TAGS` setting), `warning`, `info`.

**Check**: Verify `MESSAGE_TAGS` is configured in settings to map Django's `error` tag to Bootstrap's `danger` class:
```python
from django.contrib.messages import constants as messages
MESSAGE_TAGS = {
    messages.ERROR: 'danger',
}
```

### Query Optimization

[Source: architecture/data-models.md#Query Patterns]
[Source: architecture/security-performance.md#Database Query Optimization]

- Use `prefetch_related('tags')` on task list queryset to avoid N+1 queries
- Composite indexes already exist: `(user, status)`, `(user, priority)`, `(user, due_date)`, `(user, created_at)`
- For sorting, use Django's `order_by()` — the indexes support common sort patterns

### Priority Color Coding

[Source: architecture/source-tree.md (implied by Epic 1.5 but useful groundwork)]

Suggested Bootstrap badge classes for priority display:
- High: `badge bg-danger`
- Medium: `badge bg-warning text-dark`
- Low: `badge bg-info`

Status badge classes:
- To Do: `badge bg-secondary`
- In Progress: `badge bg-primary`
- Done: `badge bg-success`

### Project Structure

[Source: architecture/source-tree.md]

Files to create/modify for this story:
```
apps/tasks/
├── forms.py                   # NEW: TaskForm (ModelForm)
├── views.py                   # MODIFY: Add 5 CBVs
├── urls.py                    # MODIFY: Add URL patterns
└── templates/                 # NEW: Create directory
    └── tasks/                 # NEW: Create directory
        ├── task_list.html     # NEW: Task list page
        ├── task_detail.html   # NEW: Task detail page
        ├── task_form.html     # NEW: Create/edit form
        └── task_confirm_delete.html  # NEW: Delete confirmation

apps/tasks/tests/
├── test_views.py              # NEW: View tests
└── test_forms.py              # NEW: Form tests

templates/includes/
└── navbar.html                # MODIFY: Add Tasks nav link
```

### Naming Conventions

[Source: architecture/coding-standards.md#Naming Conventions]

- Python variables/functions: snake_case
- Python classes: PascalCase (e.g., `TaskListView`, `TaskForm`)
- URL names: kebab-case (e.g., `task-list`, `task-create`)
- Templates: snake_case (e.g., `task_list.html`, `task_form.html`)
- Import style: `from apps.tasks.models import Task`

### Testing

**Test file locations**: `apps/tasks/tests/test_views.py`, `apps/tasks/tests/test_forms.py`

[Source: architecture/testing-strategy.md]

**Test standards**:
- Use pytest with `pytest-django`
- Use `@pytest.mark.django_db` for database tests
- Use Factory Boy for test data — import existing factories: `from apps.tasks.tests.factories import TaskFactory` and `from apps.accounts.tests.factories import UserFactory`
- Use Django test `Client` with `client.force_login(user)` for view tests
- Descriptive test names: `test_task_list_shows_only_current_users_tasks()`
- Target coverage: views 85%+, forms 85%+

**View test patterns**:
```python
@pytest.mark.django_db
class TestTaskListView:
    def test_requires_authentication(self, client):
        url = reverse('task-list')
        response = client.get(url)
        assert response.status_code == 302
        assert '/accounts/login/' in response.url

    def test_shows_only_user_tasks(self, client):
        user = UserFactory()
        other_user = UserFactory()
        task = TaskFactory(user=user)
        other_task = TaskFactory(user=other_user)
        client.force_login(user)
        response = client.get(reverse('task-list'))
        assert task in response.context['tasks']
        assert other_task not in response.context['tasks']
```

**Login URL**: The accounts app uses `LOGIN_URL = '/accounts/login/'` — verify this is set in settings. `LoginRequiredMixin` redirects to `settings.LOGIN_URL`.

### Technical Constraints

[Source: architecture/tech-stack.md]
- Django 4.2 LTS
- Bootstrap 5.3 for responsive UI
- UUID primary keys — use `<uuid:pk>` in URL patterns
- SQLite for local dev, PostgreSQL for production

[Source: architecture/security-performance.md]
- Always filter by user for data isolation
- Use ORM (parameterized queries), no raw SQL
- Use `prefetch_related` for ManyToMany relationships
- CSRF token required in all forms

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No blocking issues. Two ruff lint warnings for unused variables in test_sort_by_priority — fixed by removing variable assignments. Two files needed `ruff format` auto-formatting.

### Completion Notes
- All 102 tests pass (28 accounts + 38 tasks models/admin + 25 task views + 11 task forms), 99% overall coverage
- Views at 100% coverage, forms at 93% coverage
- `manage.py check` — no issues
- `ruff check .` — all checks passed
- `ruff format --check .` — all files formatted
- Added `MESSAGE_TAGS` to `base.py` to map Django's error level (40) to Bootstrap's `danger` class
- Used class-based views with `LoginRequiredMixin` and `get_queryset()` user filtering for all views

### File List

**New files:**
- `apps/tasks/forms.py` — TaskForm (ModelForm) with title validation and Bootstrap widgets
- `apps/tasks/templates/tasks/task_list.html` — Task list with status filters, sort controls, pagination, badges
- `apps/tasks/templates/tasks/task_detail.html` — Task detail with full info, overdue/days-until-due display, edit/delete links
- `apps/tasks/templates/tasks/task_form.html` — Shared create/edit form with Bootstrap styling, field errors
- `apps/tasks/templates/tasks/task_confirm_delete.html` — Delete confirmation with task context
- `apps/tasks/tests/test_views.py` — 25 view tests (auth, CRUD, user isolation, messages, pagination, sorting, filtering)
- `apps/tasks/tests/test_forms.py` — 11 form tests (validation, fields, stripping)

**Modified files:**
- `apps/tasks/views.py` — 5 class-based views (TaskListView, TaskDetailView, TaskCreateView, TaskUpdateView, TaskDeleteView)
- `apps/tasks/urls.py` — 5 URL patterns with UUID pk
- `templates/includes/navbar.html` — Added "My Tasks" link for authenticated users
- `todo_project/settings/base.py` — Added MESSAGE_TAGS for Bootstrap alert mapping

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | Initial story draft | SM Agent (Bob) |
| 2026-02-10 | 1.0 | Implementation complete — all tasks done, 102 tests passing, 99% coverage | Dev Agent (James) |
